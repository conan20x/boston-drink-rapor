<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Drink & Dessert Cadde Şube Ağustos 2025 Raporu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, rgba(17, 138, 178, 0.15), transparent 40%),
                radial-gradient(circle at bottom right, rgba(214, 51, 132, 0.15), transparent 45%),
                linear-gradient(135deg, #0B1026 0%, #06141F 45%, #0F2027 100%);
            color: #F5F7FB;
            min-height: 100vh;
        }

        .page-wrapper {
            position: relative;
            max-width: 1280px;
            margin: 0 auto;
        }

        .page-wrapper::before,
        .page-wrapper::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.45;
            z-index: -1;
        }

        .page-wrapper::before {
            width: 280px;
            height: 280px;
            background: rgba(17, 138, 178, 0.35);
            top: -80px;
            right: -140px;
        }

        .page-wrapper::after {
            width: 340px;
            height: 340px;
            background: rgba(255, 107, 107, 0.28);
            bottom: -120px;
            left: -160px;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 520px;
            margin-left: auto;
            margin-right: auto;
            height: 360px;
            max-height: 420px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 420px;
            }
        }

        .glass-card {
            background: linear-gradient(160deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.65));
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 1.25rem;
            padding: 2rem;
            box-shadow: 0 30px 60px -35px rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
        }

        .kpi-card {
            background: linear-gradient(160deg, rgba(148, 163, 184, 0.18), rgba(15, 118, 110, 0.2));
            border: 1px solid rgba(94, 234, 212, 0.35);
            border-radius: 1rem;
            padding: 1.75rem;
            box-shadow: 0 25px 45px -20px rgba(16, 185, 129, 0.5);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .kpi-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 25px 65px -20px rgba(16, 185, 129, 0.65);
        }

        .section-title {
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .chart-type-group {
            display: inline-flex;
            padding: 0.25rem;
            border-radius: 9999px;
            background: rgba(148, 163, 184, 0.18);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.45);
        }

        .chart-type-button {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #CBD5F5;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            outline: none;
        }

        .chart-type-button:focus-visible {
            outline: 2px solid rgba(45, 212, 191, 0.8);
            outline-offset: 2px;
        }

        .chart-type-button[data-active="true"] {
            background: linear-gradient(135deg, #4ADE80, #2DD4BF);
            color: #0B1120;
            box-shadow: 0 8px 20px -10px rgba(45, 212, 191, 0.8);
        }

        .total-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 1.3rem;
            color: #F8FAFC;
            text-align: center;
            text-shadow: 0 8px 25px rgba(15, 23, 42, 0.6);
        }

        .gradient-text {
            background: linear-gradient(135deg, #38BDF8, #34D399, #F472B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .kpi-value {
            font-size: 2.6rem;
            letter-spacing: -0.04em;
        }
    </style>
</head>

<body class="antialiased">
    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-100 bg-opacity-75 z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
        <div class="absolute text-xl font-semibold text-gray-700">Rapor Yükleniyor...</div>
    </div>

    <div class="page-wrapper px-4 sm:px-8 md:px-10 lg:px-12 py-10 hidden" id="report-container">
        <header class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8 mb-12">
            <div class="flex items-center gap-4">
                <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-cyan-400 via-emerald-400 to-blue-500 flex items-center justify-center shadow-2xl shadow-cyan-500/30">
                    <span class="text-2xl font-bold text-slate-950">BD</span>
                </div>
                <div>
                    <p class="uppercase tracking-[0.4em] text-xs text-sky-200/80">Finansal Özet</p>
                    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold gradient-text leading-tight">Boston Drink & Dessert | Cadde Şube Ağustos 2025 Raporu</h1>
                </div>
            </div>
            <div class="glass-card flex flex-col sm:flex-row items-start sm:items-center gap-4 py-4 px-6">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-300">Rapor Dönemi</p>
                    <p class="text-lg font-semibold" id="report-period">Dönem: Yükleniyor...</p>
                </div>
                <div class="h-px sm:h-12 sm:w-px bg-slate-600/50 w-full sm:w-auto"></div>
                <div class="text-sm text-slate-300 max-w-xs leading-relaxed">
                    Cadde şubenin gelir, gider ve stok performansını tek ekranda izleyin. Grafik türünü değiştirerek farklı perspektifler yakalayın.
                </div>
            </div>
        </header>

        <section id="overview" class="mb-14">
            <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
                <h2 class="section-title text-slate-300">Genel Bakış</h2>
                <span class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-slate-400 bg-slate-900/60 border border-slate-700/60 rounded-full px-4 py-1">Anlık Güncellenen Panoramik Özet</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="kpi-card">
                    <p class="text-xs uppercase tracking-[0.3em] text-emerald-200/80">Brüt Gelir (Kasa)</p>
                    <p class="kpi-value font-bold text-emerald-200 mt-4" id="brut-gelir">Yükleniyor...</p>
                </div>
                <div class="kpi-card">
                    <p class="text-xs uppercase tracking-[0.3em] text-rose-200/80">Toplam Gider (Banka + Nakit)</p>
                    <p class="kpi-value font-bold text-rose-200 mt-4" id="toplam-gider">Yükleniyor...</p>
                </div>
                <div class="kpi-card">
                    <p class="text-xs uppercase tracking-[0.3em] text-amber-200/80">Net Dönem Kârı (Nakit Akışı)</p>
                    <p class="kpi-value font-bold text-amber-200 mt-4" id="net-kar">Yükleniyor...</p>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-14">
            <section id="gross-income" class="glass-card">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                    <div>
                        <p class="section-title text-slate-300">Gelir Yapısı</p>
                        <h2 class="text-2xl font-semibold text-white">Brüt Gelirlerin Dağılımı</h2>
                        <p class="text-sm text-slate-400" id="gross-income-subtitle">Yükleniyor...</p>
                    </div>
                    <div class="chart-type-group" data-chart-toggle="grossIncomeChart">
                        <button class="chart-type-button" data-chart-target="grossIncomeChart" data-chart-type="doughnut">Halka</button>
                        <button class="chart-type-button" data-chart-target="grossIncomeChart" data-chart-type="bar">Çubuk</button>
                        <button class="chart-type-button" data-chart-target="grossIncomeChart" data-chart-type="polarArea">Kutupsal</button>
                    </div>
                </div>
                <div class="chart-container mb-6">
                    <canvas id="grossIncomeChart"></canvas>
                    <div class="total-label" id="grossIncomeTotal"></div>
                </div>
                <div id="gross-income-list" class="space-y-3"></div>
            </section>

            <section id="net-income" class="glass-card">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                    <div>
                        <p class="section-title text-slate-300">Bankaya Yansıyan Gelir</p>
                        <h2 class="text-2xl font-semibold text-white">Net Gelirlerin Dağılımı</h2>
                        <p class="text-sm text-slate-400" id="net-income-subtitle">Yükleniyor...</p>
                    </div>
                    <div class="chart-type-group" data-chart-toggle="netIncomeChart">
                        <button class="chart-type-button" data-chart-target="netIncomeChart" data-chart-type="doughnut">Halka</button>
                        <button class="chart-type-button" data-chart-target="netIncomeChart" data-chart-type="bar">Çubuk</button>
                        <button class="chart-type-button" data-chart-target="netIncomeChart" data-chart-type="polarArea">Kutupsal</button>
                    </div>
                </div>
                <div class="chart-container mb-6">
                    <canvas id="netIncomeChart"></canvas>
                    <div class="total-label" id="netIncomeTotal"></div>
                </div>
                <div id="net-income-list" class="space-y-3"></div>
            </section>
        </div>

        <section id="chocolate-analysis" class="glass-card mb-14">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <p class="section-title text-slate-300">Hammadde & Stoklar</p>
                    <h2 class="text-2xl font-semibold text-white">Çikolata Kullanım ve Gider Analizi</h2>
                    <p class="text-sm text-slate-400">Kullanılan çikolataların miktar (KG) ve toplam maliyet (₺) dökümü.</p>
                </div>
                <div class="chart-type-group" data-chart-toggle="chocolateChart">
                    <button class="chart-type-button" data-chart-target="chocolateChart" data-chart-type="doughnut">Halka</button>
                    <button class="chart-type-button" data-chart-target="chocolateChart" data-chart-type="bar">Çubuk</button>
                    <button class="chart-type-button" data-chart-target="chocolateChart" data-chart-type="polarArea">Kutupsal</button>
                </div>
            </div>
            <div class="chart-container mb-6">
                <canvas id="chocolateChart"></canvas>
                <div class="total-label" id="chocolateTotal"></div>
            </div>
            <div id="chocolate-list" class="space-y-3"></div>
        </section>

        <section id="expenses" class="glass-card mb-14">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <p class="section-title text-slate-300">Operasyonel Giderler</p>
                    <h2 class="text-2xl font-semibold text-white">Giderlerin Dağılımı</h2>
                    <p class="text-sm text-slate-400">Tüm banka ve kasadan yapılan giderlerin detaylı dökümü.</p>
                </div>
                <div class="chart-type-group" data-chart-toggle="expenseChart">
                    <button class="chart-type-button" data-chart-target="expenseChart" data-chart-type="doughnut">Halka</button>
                    <button class="chart-type-button" data-chart-target="expenseChart" data-chart-type="bar">Çubuk</button>
                    <button class="chart-type-button" data-chart-target="expenseChart" data-chart-type="polarArea">Kutupsal</button>
                </div>
            </div>
            <div class="chart-container mb-6">
                <canvas id="expenseChart"></canvas>
                <div class="total-label" id="expenseTotal"></div>
            </div>
            <div id="expense-list" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </section>

        <!-- YENİ BÖLÜM: YEMEK KARTLARI -->
        <section id="food-cards" class="glass-card mb-14">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <p class="section-title text-slate-300">İK & Sosyal Haklar</p>
                    <h2 class="text-2xl font-semibold text-white">Personel Yemek Kartları Analizi</h2>
                    <p class="text-sm text-slate-400">Personele ait yemek kartlarına yüklenen toplam tutarlar.</p>
                </div>
                <div class="chart-type-group" data-chart-toggle="foodCardChart">
                    <button class="chart-type-button" data-chart-target="foodCardChart" data-chart-type="doughnut">Halka</button>
                    <button class="chart-type-button" data-chart-target="foodCardChart" data-chart-type="bar">Çubuk</button>
                    <button class="chart-type-button" data-chart-target="foodCardChart" data-chart-type="polarArea">Kutupsal</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="chart-container">
                    <canvas id="foodCardChart"></canvas>
                    <div class="total-label" id="foodCardTotal"></div>
                </div>
                <div id="food-card-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 border-l border-slate-700/60 pl-4">
                    <!-- Liste JavaScript ile doldurulacak -->
                </div>
            </div>
        </section>

        <!-- YENİ BÖLÜM: SEVKİYAT DETAYLARI -->
        <section id="shipment" class="glass-card mb-14">
            <div class="flex flex-col gap-3 mb-6">
                <p class="section-title text-slate-300">Tedarik Zinciri</p>
                <h2 class="text-2xl font-semibold text-white">Genel Merkez Sevkiyat Detayları</h2>
                <p class="text-sm text-slate-400">Dönem içinde genel merkezden yapılan ürün sevkiyatlarının dökümü.</p>
            </div>
            <div id="shipment-list" class="space-y-3">
                <!-- Sevkiyat listesi JavaScript ile doldurulacak -->
            </div>
            <div id="shipment-total-container" class="mt-6 pt-6 border-t border-slate-700/70 text-right">
                <span class="text-sm uppercase tracking-[0.3em] text-slate-400">Sevkiyat Toplam Tutarı</span>
                <p id="shipment-total" class="text-3xl font-bold text-emerald-200 mt-2">Yükleniyor...</p>
            </div>
        </section>


        <section id="cashflow" class="glass-card mb-14">
            <div class="flex flex-col gap-3 mb-6">
                <p class="section-title text-slate-300">Likidite Nabzı</p>
                <h2 class="text-2xl font-semibold text-white">Nakit Akışı ve Banka Analizi</h2>
                <p class="text-sm text-slate-400">Bankaya yatan net tutarlar ile tüm giderler arasındaki fark.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="space-y-5">
                    <h3 class="font-semibold text-lg text-white">Online Platform Komisyon Analizi</h3>
                    <div id="online-commission-list" class="space-y-4"></div>
                    <div class="mt-6 p-6 rounded-2xl bg-gradient-to-br from-sky-400/10 via-cyan-400/10 to-emerald-400/10 border border-sky-300/20 shadow-lg shadow-sky-500/10">
                        <h4 class="font-semibold text-sky-200" id="total-commission-header"></h4>
                        <p class="text-sm text-slate-200/80 leading-relaxed" id="total-commission-text"></p>
                    </div>
                </div>
                <div class="space-y-5">
                    <h3 class="font-semibold text-lg text-white">Dönem Sonu Finansal Durum</h3>
                    <div id="financial-status-list" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <section id="admin-panel" class="glass-card mt-12 mb-12">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-6">
                <div>
                    <p class="section-title text-slate-300">Veri Yönetimi</p>
                    <h2 class="text-2xl font-semibold text-white">Gizli Yönetici Paneli</h2>
                    <p class="text-sm text-slate-400 mt-2 max-w-xl">Yetkili kullanıcılar tek tuşla rapor veri setini güncelleyebilir. Güvenli bağlantı üzerinden Firebase ile eş zamanlı çalışır.</p>
                </div>
                <button id="updateDataBtn" class="px-6 py-3 rounded-full font-semibold uppercase tracking-[0.3em] bg-gradient-to-r from-sky-500 to-emerald-400 text-slate-950 shadow-xl shadow-emerald-500/30 hover:shadow-emerald-400/40 transition duration-300">Örnek Veriyi Güncelle</button>
            </div>
        </section>

        <footer class="text-center text-xs text-slate-400/80 mt-16 pb-10">
            <p>Bu rapor, güvenli veri kaynaklarına dayanarak oluşturulmuştur ve finansal danışmanlık yerine geçmez.</p>
            <p>Rapor Tarihi: 6 Eylül 2025</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ve Uygulama Ayarları
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;
        let charts = {};
        const chartStates = {};
        const radialChartTypes = ['doughnut', 'polarArea', 'pie'];

        const loadingSpinner = document.getElementById('loading-spinner');
        const reportContainer = document.getElementById('report-container');

        // Örnek Rapor Verileri (Bu veriler veritabanına kaydedilecek)
        const sampleReportData = {
            period: '01.08.2025 - 04.09.2025',
            kpi: {
                brutGelir: 1704018.00,
                toplamGider: 1347540.82,
                netKar: 109550.17
            },
            grossIncome: {
                labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit'],
                data: [728958, 547510, 162820, 142555, 122175]
            },
            netIncome: {
                labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit'],
                data: [729092.33, 396173.05, 104019.71, 96789.04, 122175]
            },
            chocolate: {
                labels: ['Sütlü Çikolata', 'Bitter Çikolata', 'Beyaz Çikolata', 'Ruby Çikolata', 'Gold Çikolata'],
                costs: [
                    { name: 'Sütlü Çikolata', kg: 360, pricePerKg: 690 },
                    { name: 'Bitter Çikolata', kg: 40, pricePerKg: 730 },
                    { name: 'Beyaz Çikolata', kg: 60, pricePerKg: 690 },
                    { name: 'Ruby Çikolata', kg: 12.5, pricePerKg: 835 },
                    { name: 'Gold Çikolata', kg: 15, pricePerKg: 950 }
                ],
                colors: ['#A0522D', '#2F2F2F', '#F5F5DC', '#E91E63', '#FFD700']
            },
            expenses: {
                labels: [
                    'Genel Merkeze Ödeme', 'Personel Maaşları (Banka)', 'Personel Maaşları (Nakit)', 'Stajyer Maaşı',
                    'Kredi Kartı Borç Ödemesi', 'Dükkan Kirası', 'Ev Kirası', 'Manav Ödemesi', 'Elektrik Faturası',
                    'Geçici Vergi Ödemesi', 'Yemek Kartları Ödemesi', 'İçim Süt Ödemesi', 'Nakit Diğer Ödemeler',
                    'Arıtma Değişim Ücreti', 'Su Faturası', 'Cam Temizlik Ödeme', 'Vantilatör Lamba Ödemesi',
                    'Filtre Bakım Ödemesi', 'İlaçlama Ödeme', 'Yazılım Bakım Ücreti', 'Telefon Faturası',
                    'İnternet Faturası', 'Havale Ücreti'
                ],
                data: [
                    426283.57, 116000.00, 76115.00, 30050.00, 175177.17, 92000.00, 25000.00, 100280.00, 71310.00,
                    65946.00, 20001.54, 24697.62, 12730.00, 8400.00, 5126.00, 4800.00, 2000.00, 1500.00,
                    1500.00, 798.00, 781.50, 420.00, 409.42
                ]
            },
            foodCards: {
                labels: ['Merve', 'Nesibe', 'Hacer', 'Enise', 'Ezel', 'Berkay', 'Emre Albay', 'Furkan', 'İbrahim', 'Emre Yeşilçayır', 'Taha', 'Aslı', 'Alp', 'Yeşim'],
                data: [3030, 2042.54, 3030, 3000, 1900, 1590, 2176, 2170, 441, 1465, 1235, 370, 1820, 1792]
            },
            shipmentDetails: [
                { name: 'CALLEBAUT BEYAZ ÇİKOLATA (10 KG)', quantity: 60, unit: 'KG', price: 41814.00 },
                { name: 'CALLEBAUT BITTER ÇİKOLATA (10 KG)', quantity: 40, unit: 'KG', price: 29492.00 },
                { name: 'CALLEBAUT RUBY ÇİKOLATA (10 KG)', quantity: 10, unit: 'KG', price: 8433.50 },
                { name: 'CALLEBAUT SÜTLÜ ÇİKOLATA (10 KG)', quantity: 300, unit: 'KG', price: 209070.00 },
                { name: 'BOSTON CRUST PAKET ALL IN ONE KUTU 1/1', quantity: 1, unit: 'PAKET', price: 3600.00 },
                { name: 'BOSTON CRUST PAKET ALL IN ONE KUTU 1/2', quantity: 1, unit: 'PAKET', price: 2760.00 },
                { name: 'BOSTON BASKILI KRAFT SAPLI ÇANTA', quantity: 1, unit: 'KOLİ', price: 1500.00 },
                { name: 'BASKILI KRAFT KESE KAĞIDI KG', quantity: 1, unit: 'KOLİ', price: 3240.00 },
                { name: 'BOSTON BASKILI PEÇETE', quantity: 2, unit: 'ADET', price: 2040.00 },
                { name: 'BOSTON CRUST MIX WAFFLE KUTU', quantity: 1, unit: 'PAKET', price: 2100.00 },
                { name: 'BOSTON BASKILI MİNİ KAP', quantity: 2, unit: 'KOLİ', price: 4320.00 },
                { name: 'BOSTON BASKILI TAM KAP', quantity: 1, unit: 'KOLİ', price: 1710.00 },
                { name: 'BOSTON BASKILI ŞEFFAF BARDAK 12 OZ', quantity: 1, unit: 'KOLİ', price: 3840.00 },
                { name: 'TORKU TAM BUĞDAYLI BİSKÜVİ TOZU', quantity: 2, unit: 'KOLİ', price: 1575.60 },
                { name: 'CALLEBAUT KREP KIRIĞI (10 KG)', quantity: 20, unit: 'KG', price: 13332.00 },
                { name: 'BOSTON BASKILI DEMLİK POŞET ÇAY', quantity: 1, unit: 'KOLİ', price: 1818.00 },
                { name: 'DVG BAR SOS KARAMEL (2KG)', quantity: 1, unit: 'ADET', price: 1187.76 },
                { name: 'CALLEBAUT GOLD KARAMEL ÇİKOLATA (10KG)', quantity: 10, unit: 'KG', price: 9595.00 }
            ],
            onlineCommissions: [
                { name: 'Yemeksepeti', gross: 547510.00, net: 396173.05, color: '#FF6B6B' },
                { name: 'Getir', gross: 162820.00, net: 104019.71, color: '#FFD166' },
                { name: 'Trendyol', gross: 142555.00, net: 96789.04, color: '#06D6A0' }
            ],
            financialStatus: {
                bankaGelirleri: 1334915.99,
                bankaGiderleri: 1258695.82,
                nakitGelir: 122175.00,
                nakitGider: 88845.00
            }
        };

        Chart.defaults.color = '#E2E8F0';
        Chart.defaults.font.family = 'Inter, sans-serif';

        // Veri Formatlama ve Grafik Fonksiyonları
        const formatCurrency = (value) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(value);
        const formatAmountWithSign = (amount) => {
            const formatted = formatCurrency(Math.abs(amount));
            return amount < 0 ? `-` + formatted : formatted;
        };
        const hexToRgba = (hex, alpha = 1) => {
            if (!hex) return `rgba(226, 232, 240, ${alpha})`;
            let sanitized = hex.replace('#', '');
            if (sanitized.length === 3) {
                sanitized = sanitized.split('').map(char => char + char).join('');
            }
            const bigint = parseInt(sanitized, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };
        const getChartOptions = (type) => {
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 14,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.label}: ${formatCurrency(context.raw)}`
                        }
                    }
                }
            };

            if (type === 'doughnut') {
                return {
                    ...baseOptions,
                    cutout: '65%'
                };
            }

            if (type === 'bar') {
                return {
                    ...baseOptions,
                    plugins: {
                        ...baseOptions.plugins,
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(148, 163, 184, 0.15)' },
                            ticks: { color: '#CBD5F5', font: { size: 12, weight: '600' } }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(148, 163, 184, 0.12)' },
                            ticks: {
                                color: '#CBD5F5',
                                callback: (value) => formatCurrency(value)
                            }
                        }
                    }
                };
            }

            if (type === 'polarArea') {
                return {
                    ...baseOptions,
                    scales: {
                        r: {
                            grid: { color: 'rgba(148, 163, 184, 0.2)' },
                            ticks: { color: '#CBD5F5' }
                        }
                    }
                };
            }

            return baseOptions;
        };
        const buildDataset = (type, colors, data) => {
            if (type === 'bar') {
                return {
                    label: 'Tutar',
                    data,
                    backgroundColor: colors.map(color => hexToRgba(color, 0.75)),
                    borderColor: colors,
                    borderWidth: 2,
                    borderRadius: 10,
                    hoverBackgroundColor: colors.map(color => hexToRgba(color, 0.95))
                };
            }

            return {
                data,
                backgroundColor: colors.map(color => hexToRgba(color, 0.9)),
                borderColor: '#0F172A',
                borderWidth: type === 'polarArea' ? 1 : 3
            };
        };
        const setActiveChartButton = (chartId, type) => {
            const buttons = document.querySelectorAll(`.chart-type-button[data-chart-target="${chartId}"]`);
            buttons.forEach(button => {
                const isActive = button.dataset.chartType === type;
                button.dataset.active = isActive ? 'true' : 'false';
            });
        };
        const renderChart = (chartId, type) => {
            const state = chartStates[chartId];
            if (!state) return;

            const ctx = document.getElementById(chartId).getContext('2d');
            const total = state.data.reduce((sum, val) => sum + val, 0);
            const totalElement = document.getElementById(state.totalElementId);

            if (charts[chartId]) {
                charts[chartId].destroy();
            }

            const newChart = new Chart(ctx, {
                type,
                data: {
                    labels: state.labels,
                    datasets: [buildDataset(type, state.colors, state.data)]
                },
                options: getChartOptions(type)
            });

            charts[chartId] = newChart;
            state.currentType = type;

            if (radialChartTypes.includes(type)) {
                totalElement.textContent = formatCurrency(total);
                totalElement.style.display = 'block';
            } else {
                totalElement.style.display = 'none';
            }

            setActiveChartButton(chartId, type);
        };
        const createInteractiveChart = (ctxId, labels, data, colors, totalElementId, defaultType = 'doughnut') => {
            const existingState = chartStates[ctxId];
            const targetType = existingState?.currentType || defaultType;
            chartStates[ctxId] = { labels, data, colors, totalElementId, currentType: targetType };
            renderChart(ctxId, targetType);
        };
        const updateChartType = (chartId, type) => {
            const state = chartStates[chartId];
            if (!state || state.currentType === type) return;
            renderChart(chartId, type);
        };
        const createList = (listId, data, containerClass, formatFunc, valueClass = 'text-slate-100') => {
            const listContainer = document.getElementById(listId);
            listContainer.innerHTML = '';
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `flex justify-between items-center gap-4 p-3 rounded-xl border ${containerClass}`;
                div.innerHTML = `<span class="font-medium text-slate-200">${item.label}</span><span class="font-semibold ${valueClass}">${formatFunc(item.value)}</span>`;
                listContainer.appendChild(div);
            });
        };

        const renderReport = (reportData) => {
            if (!reportData) {
                console.error("Rapor verisi bulunamadı.");
                return;
            }

            document.getElementById('report-period').textContent = `Dönem: ${reportData.period}`;
            document.getElementById('brut-gelir').textContent = formatCurrency(reportData.kpi.brutGelir);
            document.getElementById('toplam-gider').textContent = formatCurrency(reportData.kpi.toplamGider);
            document.getElementById('net-kar').textContent = formatCurrency(reportData.kpi.netKar);

            // Brut Gelir Listesi ve Grafiği
            document.getElementById('gross-income-subtitle').textContent = `Kasa raporuna göre toplam ${formatCurrency(reportData.grossIncome.data.reduce((sum, val) => sum + val, 0))}'lik brüt gelirin kaynaklara göre dökümü.`;
            createList('gross-income-list', reportData.grossIncome.labels.map((label, i) => ({
                label: label,
                value: reportData.grossIncome.data[i]
            })).sort((a, b) => b.value - a.value), 'border-emerald-400/20 bg-emerald-500/10', formatCurrency, 'text-emerald-200');
            createInteractiveChart('grossIncomeChart', reportData.grossIncome.labels, reportData.grossIncome.data, ['#38BDF8', '#22D3EE', '#F97316', '#F472B6', '#34D399'], 'grossIncomeTotal');

            // Net Gelir Listesi ve Grafiği
            document.getElementById('net-income-subtitle').textContent = `Bankaya yatan ve kasadaki net gelirin kaynaklara göre dökümü.`;
            createList('net-income-list', reportData.netIncome.labels.map((label, i) => ({
                label: label,
                value: reportData.netIncome.data[i]
            })).sort((a, b) => b.value - a.value), 'border-sky-400/20 bg-sky-500/10', formatCurrency, 'text-sky-200');
            createInteractiveChart('netIncomeChart', reportData.netIncome.labels, reportData.netIncome.data, ['#60A5FA', '#38BDF8', '#F97316', '#F472B6', '#34D399'], 'netIncomeTotal');

            // Çikolata Gider Listesi ve Grafiği (Büyükten Küçüğe Sıralı)
            const chocolateDetails = reportData.chocolate.costs.map((c, i) => ({
                ...c,
                totalCost: c.kg * c.pricePerKg,
                color: reportData.chocolate.colors[i]
            })).sort((a, b) => b.totalCost - a.totalCost);

            const chocolateData = chocolateDetails.map(c => c.totalCost);
            const chocolateLabels = chocolateDetails.map(c => c.name);
            const chocolateColors = chocolateDetails.map(c => c.color);
            createInteractiveChart('chocolateChart', chocolateLabels, chocolateData, chocolateColors, 'chocolateTotal');

            const chocolateList = document.getElementById('chocolate-list');
            chocolateList.innerHTML = '';
            chocolateDetails.forEach(c => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center gap-4 p-3 rounded-xl border border-slate-700/60 bg-slate-900/60';
                const accent = hexToRgba(c.color, 0.7);
                div.style.boxShadow = `0 12px 30px -20px ${accent}`;
                div.innerHTML = `<span class="font-medium text-slate-200">${c.name}</span><span class="font-semibold" style="color:${hexToRgba(c.color, 0.9)}">${c.kg} KG (${formatCurrency(c.totalCost)})</span>`;
                chocolateList.appendChild(div);
            });

            // Giderler Listesi ve Grafiği (Büyükten Küçüğe Sıralı)
            const categorizedExpenses = {
                'Genel Merkeze Ödeme': reportData.expenses.data[0],
                'Personel Maaşları': reportData.expenses.data[1] + reportData.expenses.data[2] + reportData.expenses.data[3],
                'Kredi Kartı Borcu': reportData.expenses.data[4],
                'Kiralar': reportData.expenses.data[5] + reportData.expenses.data[6],
                'Manav Ödemesi': reportData.expenses.data[7],
                'Vergi & Faturalar': reportData.expenses.data[8] + reportData.expenses.data[9] + reportData.expenses.data[14] + reportData.expenses.data[20] + reportData.expenses.data[21],
                'Diğer Giderler': [10, 11, 12, 13, 15, 16, 17, 18, 19, 22].reduce((sum, i) => sum + reportData.expenses.data[i], 0)
            };

            const sortedCategorizedExpenses = Object.entries(categorizedExpenses).sort(([, a], [, b]) => b - a);
            const sortedCategorizedLabels = sortedCategorizedExpenses.map(([label]) => label);
            const sortedCategorizedData = sortedCategorizedExpenses.map(([, value]) => value);
            const expenseColors = ['#FB7185', '#38BDF8', '#818CF8', '#F97316', '#2DD4BF', '#FACC15', '#A855F7'];
            createInteractiveChart('expenseChart', sortedCategorizedLabels, sortedCategorizedData, expenseColors, 'expenseTotal');

            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            const combinedExpenses = reportData.expenses.labels.map((label, i) => ({
                label: label,
                value: reportData.expenses.data[i]
            })).sort((a, b) => b.value - a.value);

            combinedExpenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center gap-4 p-3 rounded-xl border border-rose-500/30 bg-rose-500/10';
                div.innerHTML = `<span class="text-slate-200">${expense.label}</span><span class="font-semibold text-rose-200">${formatAmountWithSign(-expense.value)}</span>`;
                expenseList.appendChild(div);
            });

            // YEMEK KARTLARI (Büyükten Küçüğe Sıralı)
            const combinedFoodCards = reportData.foodCards.labels.map((label, i) => ({
                label: label,
                value: reportData.foodCards.data[i]
            })).sort((a, b) => b.value - a.value);

            const sortedFoodCardLabels = combinedFoodCards.map(item => item.label);
            const sortedFoodCardData = combinedFoodCards.map(item => item.value);
            const foodCardColors = ['#8B5CF6', '#6366F1', '#F97316', '#FACC15', '#14B8A6', '#F472B6', '#0EA5E9', '#22D3EE', '#10B981', '#FB7185', '#A855F7', '#F59E0B', '#38BDF8', '#2DD4BF'];
            createInteractiveChart('foodCardChart', sortedFoodCardLabels, sortedFoodCardData, foodCardColors, 'foodCardTotal');
            createList('food-card-list', combinedFoodCards, 'border-indigo-400/30 bg-indigo-500/10', formatCurrency, 'text-indigo-200');

            // SEVKİYAT LİSTESİ (Büyükten Küçüğe Sıralı)
            const shipmentListContainer = document.getElementById('shipment-list');
            shipmentListContainer.innerHTML = '';
            let totalShipmentCost = 0;
            const sortedShipments = [...reportData.shipmentDetails].sort((a, b) => b.price - a.price);

            sortedShipments.forEach(item => {
                totalShipmentCost += item.price;
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 p-4 rounded-xl border border-slate-700/60 bg-slate-900/60 shadow-lg shadow-slate-900/40';
                div.innerHTML = `
                    <div class="font-medium text-slate-200">${item.name} <span class="text-sm text-slate-400 font-normal">(${item.quantity} ${item.unit})</span></div>
                    <div class="font-semibold text-lg text-emerald-200 mt-1 sm:mt-0">${formatCurrency(item.price)}</div>
                `;
                shipmentListContainer.appendChild(div);
            });
            document.getElementById('shipment-total').textContent = formatCurrency(totalShipmentCost);

            // Nakit Akışı ve Komisyon Analizi
            const onlineCommissionList = document.getElementById('online-commission-list');
            onlineCommissionList.innerHTML = '';
            let totalCommission = 0;
            reportData.onlineCommissions.forEach(platform => {
                const commission = platform.gross - platform.net;
                totalCommission += commission;
                const commissionPercentage = ((commission / platform.gross) * 100).toFixed(1);

                const div = document.createElement('div');
                div.className = 'space-y-2 p-4 rounded-xl border border-slate-700/60 bg-slate-900/60 shadow-inner shadow-sky-500/10';
                div.innerHTML = `
                    <div class="flex justify-between font-semibold text-slate-200"><span>${platform.name}</span><span class="text-rose-300">${formatAmountWithSign(-commission)} (%${commissionPercentage})</span></div>
                    <div class="w-full bg-slate-800/70 rounded-full h-3">
                        <div class="bg-gradient-to-r from-rose-400 via-amber-300 to-emerald-300 h-3 rounded-full" style="width:${commissionPercentage}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400"><span>Brüt: ${formatCurrency(platform.gross)}</span><span>Net Gelen: ${formatCurrency(platform.net)}</span></div>
                `;
                onlineCommissionList.appendChild(div);
            });

            document.getElementById('total-commission-header').textContent = `Toplam Komisyon Gideri: ${formatCurrency(totalCommission)}`;
            document.getElementById('total-commission-text').textContent = `Online platformlardan elde edilen ${formatCurrency(reportData.onlineCommissions.reduce((sum, p) => sum + p.gross, 0))} brüt cironun bankaya yatan net karşılığı ${formatCurrency(reportData.onlineCommissions.reduce((sum, p) => sum + p.net, 0))}'dir. Aradaki fark, platformların hizmet bedeli ve komisyonlarıdır.`;

            const financialStatusList = document.getElementById('financial-status-list');
            financialStatusList.innerHTML = '';
            const bankNetFlow = reportData.financialStatus.bankaGelirleri - reportData.financialStatus.bankaGiderleri;
            const cashNetFlow = reportData.financialStatus.nakitGelir - reportData.financialStatus.nakitGider;
            const totalAssets = bankNetFlow + cashNetFlow;

            financialStatusList.innerHTML = `
                <div class="flex justify-between items-center p-4 rounded-xl border border-slate-700/60 bg-slate-900/60"><span class="text-slate-300">Toplam Banka Gelirleri</span><span class="font-semibold text-emerald-200">${formatCurrency(reportData.financialStatus.bankaGelirleri)}</span></div>
                <div class="flex justify-between items-center p-4 rounded-xl border border-slate-700/60 bg-slate-900/60"><span class="text-slate-300">Toplam Banka Giderleri</span><span class="font-semibold text-rose-300">${formatAmountWithSign(-reportData.financialStatus.bankaGiderleri)}</span></div>
                <div class="flex justify-between items-center p-4 rounded-xl border border-sky-500/30 bg-sky-500/10 font-semibold text-slate-100"><span>Banka Net Akışı</span><span>${formatAmountWithSign(bankNetFlow)}</span></div>
                <hr class="my-3 border-slate-700/60">
                <div class="flex justify-between items-center p-4 rounded-xl border border-slate-700/60 bg-slate-900/60"><span class="text-slate-300">Nakit Gelir (Kasa)</span><span class="font-semibold text-emerald-200">${formatCurrency(reportData.financialStatus.nakitGelir)}</span></div>
                <div class="flex justify-between items-center p-4 rounded-xl border border-slate-700/60 bg-slate-900/60"><span class="text-slate-300">Nakit Gider (Kasa)</span><span class="font-semibold text-rose-300">${formatAmountWithSign(-reportData.financialStatus.nakitGider)}</span></div>
                <div class="flex justify-between items-center p-4 rounded-xl border border-sky-500/30 bg-sky-500/10 font-semibold text-slate-100"><span>Kasa Net Akışı</span><span>${formatAmountWithSign(cashNetFlow)}</span></div>
                <hr class="my-3 border-dashed border-slate-600/60">
                <div class="flex justify-between items-center p-5 rounded-2xl bg-gradient-to-r from-amber-400/20 via-emerald-400/20 to-sky-400/20 text-lg font-semibold text-slate-100 border border-amber-200/30"><span>Toplam Nakit + Banka Varlığı</span><span>${formatAmountWithSign(totalAssets)}</span></div>
            `;

            loadingSpinner.classList.add('hidden');
            reportContainer.classList.remove('hidden');
        };

        // Veritabanı ve kimlik doğrulama işlemleri
        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelectorAll('.chart-type-button').forEach(button => {
                button.addEventListener('click', () => {
                    updateChartType(button.dataset.chartTarget, button.dataset.chartType);
                });
            });

            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase'e başarılı bir şekilde giriş yapıldı. UID:", userId);

                            // Veritabanından veriyi dinle
                            const docRef = doc(db, `artifacts/${appId}/public/data/reports`, 'agustos2025-rapor');
                            onSnapshot(docRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    renderReport(docSnap.data());
                                } else {
                                    console.log("Rapor verisi bulunamadı. Örnek veriyi kaydediyor...");
                                    // Eğer rapor yoksa, örnek veriyi kaydet
                                    setDoc(docRef, sampleReportData)
                                        .then(() => console.log("Örnek veri başarıyla kaydedildi."))
                                        .catch(error => console.error("Veri kaydetme hatası:", error));
                                }
                            }, (error) => {
                                console.error("Veritabanı dinleme hatası:", error);
                                loadingSpinner.classList.add('hidden');
                                document.getElementById('report-container').innerHTML = '<p class="text-center text-red-500 text-xl font-bold mt-10">Rapor yüklenirken bir hata oluştu. Lütfen konsolu kontrol edin.</p>';
                            });

                        } else {
                            console.log("Kullanıcı oturumu açılmadı. Yerel örnek veri kullanılıyor.");
                            renderReport(sampleReportData);
                        }
                    });

                } else {
                    console.error("Firebase yapılandırması eksik. Yerel örnek veri kullanılıyor.");
                    renderReport(sampleReportData);
                }

                // Veri güncelleme butonu işlevi
                document.getElementById('updateDataBtn').addEventListener('click', async () => {
                    if (!db) {
                        alert("Veritabanı bağlantısı henüz kurulmadı.");
                        return;
                    }
                    const docRef = doc(db, `artifacts/${appId}/public/data/reports`, 'agustos2025-rapor');
                    try {
                        await setDoc(docRef, sampleReportData);
                        console.log("Veri güncelleme isteği gönderildi.");
                    } catch (e) {
                        console.error("Veri güncelleme hatası:", e);
                    }
                });

            } catch (error) {
                console.error("Uygulama başlatılırken hata:", error);
                loadingSpinner.classList.add('hidden');
                document.getElementById('report-container').innerHTML = '<p class="text-center text-red-500 text-xl font-bold mt-10">Uygulama başlatılırken bir hata oluştu. Lütfen konsolu kontrol edin.</p>';
            }
        });

    </script>
</body>

</html>
