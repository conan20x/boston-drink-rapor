<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Drink & Dessert Cadde Şube Finansal Raporu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <!-- AI Response Formatter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, rgba(17, 138, 178, 0.15), transparent 40%),
                radial-gradient(circle at bottom right, rgba(214, 51, 132, 0.15), transparent 45%),
                linear-gradient(135deg, #0B1026 0%, #06141F 45%, #0F2027 100%);
            color: #F5F7FB;
            min-height: 100vh;
        }

        .page-wrapper {
            position: relative;
            max-width: 1280px;
            margin: 0 auto;
        }

        .page-wrapper::before,
        .page-wrapper::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.45;
            z-index: -1;
        }

        .page-wrapper::before {
            width: 280px;
            height: 280px;
            background: rgba(17, 138, 178, 0.35);
            top: -80px;
            right: -140px;
        }

        .page-wrapper::after {
            width: 340px;
            height: 340px;
            background: rgba(255, 107, 107, 0.28);
            bottom: -120px;
            left: -160px;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 520px;
            margin-left: auto;
            margin-right: auto;
            height: 360px;
            max-height: 420px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 420px;
            }
        }

        .glass-card {
            background: linear-gradient(160deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.65));
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 1.25rem;
            padding: 2rem;
            box-shadow: 0 30px 60px -35px rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
        }

        .kpi-card {
            background: linear-gradient(160deg, rgba(148, 163, 184, 0.18), rgba(15, 118, 110, 0.2));
            border: 1px solid rgba(94, 234, 212, 0.35);
            border-radius: 1rem;
            padding: 1.75rem;
            box-shadow: 0 25px 45px -20px rgba(16, 185, 129, 0.5);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .kpi-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 25px 65px -20px rgba(16, 185, 129, 0.65);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .kpi-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.75rem;
            height: 2.75rem;
            border-radius: 0.9rem;
            box-shadow: 0 20px 35px -18px rgba(14, 165, 233, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.35);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover .kpi-icon {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 25px 45px -22px rgba(45, 212, 191, 0.55);
        }

        .kpi-icon svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .kpi-icon--income {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.4), rgba(45, 212, 191, 0.55));
        }

        .kpi-icon--expense {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.4), rgba(251, 191, 36, 0.45));
        }

        .kpi-icon--positive {
            background: linear-gradient(135deg, rgba(186, 230, 253, 0.4), rgba(59, 130, 246, 0.55));
        }

        .kpi-icon--negative {
            background: linear-gradient(135deg, rgba(252, 165, 165, 0.35), rgba(248, 113, 113, 0.5));
        }

        .section-title {
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .chart-type-group {
            display: inline-flex;
            padding: 0.25rem;
            border-radius: 9999px;
            background: rgba(148, 163, 184, 0.18);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.45);
        }

        .chart-type-button {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #CBD5F5;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            outline: none;
        }

        .chart-type-button:focus-visible {
            outline: 2px solid rgba(45, 212, 191, 0.8);
            outline-offset: 2px;
        }

        .chart-type-button[data-active="true"] {
            background: linear-gradient(135deg, #4ADE80, #2DD4BF);
            color: #0B1120;
            box-shadow: 0 8px 20px -10px rgba(45, 212, 191, 0.8);
        }

        .total-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 1.3rem;
            color: #F8FAFC;
            text-align: center;
            text-shadow: 0 8px 25px rgba(15, 23, 42, 0.6);
        }

        .gradient-text {
            background: linear-gradient(135deg, #38BDF8, #34D399, #F472B6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .kpi-value {
            font-size: 2.6rem;
            letter-spacing: -0.04em;
        }

        .month-switcher {
            display: inline-flex;
            padding: 0.35rem;
            border-radius: 9999px;
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.45), 0 12px 35px -20px rgba(14, 165, 233, 0.45);
            gap: 0.35rem;
        }

        .month-button {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0.55rem 1.35rem;
            border-radius: 9999px;
            border: none;
            background: transparent;
            color: rgba(226, 232, 240, 0.85);
            transition: all 0.25s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .month-button::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.25), rgba(59, 130, 246, 0.35));
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .month-button span {
            position: relative;
            z-index: 1;
        }

        .month-button[data-active="true"],
        .month-button:hover {
            color: #0F172A;
        }

        .month-button[data-active="true"]::after,
        .month-button:hover::after {
            opacity: 1;
        }

        /* YENİ EKLENEN STİLLER */
        .ai-button {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 1.25rem;
            border-radius: 9999px;
            font-weight: 600;
            color: #0F172A;
            background: linear-gradient(135deg, #A5B4FC, #818CF8);
            border: 1px solid rgba(199, 210, 254, 0.5);
            box-shadow: 0 10px 30px -12px rgba(129, 140, 248, 0.6);
            transition: all 0.25s ease;
            cursor: pointer;
        }
        .ai-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px -12px rgba(129, 140, 248, 0.7);
        }
        .ai-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .ai-button .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top-color: #0F172A;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* GÜNCELLENEN AI İÇERİK STİLLERİ */
        #ai-analysis-content h3 {
            font-size: 1.25rem; /* Biraz daha büyük */
            font-weight: 700; /* Daha kalın */
            margin-top: 1.75rem; /* Daha fazla üst boşluk */
            margin-bottom: 1rem; /* Daha fazla alt boşluk */
            color: #C7D2FE; /* İndigo rengi */
            padding-bottom: 0.75rem; /* Alt çizgi için boşluk */
            border-bottom: 2px solid rgba(129, 140, 248, 0.3); /* Daha belirgin alt çizgi */
        }
        #ai-analysis-content ul {
            list-style-position: inside;
            list-style-type: ' ✓ '; /* Güzel tik işareti */
            padding-left: 0.5rem;
            color: #E2E8F0; /* Açık gri */
            margin-top: 1rem; /* Listeden önce boşluk */
        }
        #ai-analysis-content li {
            margin-bottom: 0.75rem; /* Liste elemanları arası boşluk */
            background: rgba(129, 140, 248, 0.05); /* Çok hafif vurgu arkaplanı */
            border-left: 3px solid #818CF8; /* Vurgu için sol kenarlık */
            padding: 0.75rem 0.75rem 0.75rem 1.25rem; /* İç boşluklar */
            border-radius: 0 0.5rem 0.5rem 0; /* Köşe yuvarlatma */
            line-height: 1.6;
        }
        #ai-analysis-content p {
            line-height: 1.7; /* Daha okunaklı satır yüksekliği */
            color: #CBD5F5; /* Paragraflar için daha açık renk */
            margin-bottom: 1rem; /* Paragraflar arası boşluk */
        }
        /* KALIN METİNLERİ VURGULAMAK İÇİN YENİ KURAL */
        #ai-analysis-content strong {
            color: #F8FAFC; /* Parlak beyaz */
            font-weight: 700;
        }
        /* Başlıklardan hemen sonra gelen paragraflar (giriş metinleri) */
        #ai-analysis-content h3 + p {
             color: #E2E8F0;
             font-size: 1.05rem; /* Giriş metni için biraz daha büyük font */
        }

        /* --- YETKİLENDİRME (AUTH) BÖLÜMÜ STİLLERİ --- */
        #auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        #auth-card {
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        #auth-card input[type="email"] {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: #F5F7FB;
            width: 100%;
            padding: 0.85rem 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 1.25rem;
            font-size: 1rem;
            box-shadow: 0 15px 35px -20px rgba(15, 23, 42, 0.8);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #auth-card input[type="email"]::placeholder {
            color: #94A3B8;
        }
        #auth-card input[type="email"]:focus {
            outline: none;
            border-color: rgba(56, 189, 248, 0.8);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3), 0 15px 35px -20px rgba(15, 23, 42, 0.8);
        }

        #auth-card button {
            width: 100%;
            padding: 0.85rem 1.25rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: #0B1120;
            background: linear-gradient(135deg, #38BDF8, #34D399);
            box-shadow: 0 15px 35px -15px rgba(56, 189, 248, 0.5);
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        #auth-card button:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px -15px rgba(56, 189, 248, 0.6);
        }
        #auth-card button:disabled {
            background: #334155;
            color: #94A3B8;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        
        #auth-card .spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid transparent;
            border-top-color: #0B1120;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        #auth-message {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            min-height: 1.5rem; /* Hata mesajları için yer ayırır */
        }
        .auth-message-success {
            color: #34D399;
        }
        .auth-message-error {
            color: #F87171;
        }

    </style>
</head>

<body class="antialiased">

    <!-- YETKİLENDİRME (AUTH) BÖLÜMÜ -->
    <div id="auth-container">
        <div id="auth-card" class="glass-card">
            <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-cyan-400 via-emerald-400 to-blue-500 flex items-center justify-center shadow-2xl shadow-cyan-500/30 mx-auto mb-6">
                <span class="text-2xl font-bold text-slate-950">BD</span>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Finansal Raporlama</h1>
            <p class="text-slate-300 mb-8">Erişim için lütfen e-posta adresinizi girin. Size özel bir giriş bağlantısı gönderilecektir.</p>
            
            <form id="auth-form">
                <input type="email" id="email-input" placeholder="e-posta@adresiniz.com" required class="block">
                <button type="submit" id="auth-button">
                    <span>Giriş Bağlantısı Gönder</span>
                </button>
            </form>
            
            <div id="auth-message" class="auth-message-error"></div>
        </div>
    </div>


    <!-- Yükleme Ekranı (Rapor için) -->
    <div id="loading-spinner" class="fixed inset-0 flex-col items-center justify-center bg-gray-100 bg-opacity-75 z-50 hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
        <div class="mt-4 text-xl font-semibold text-gray-700">Rapor Yükleniyor...</div>
    </div>

    <!-- Ana Rapor İçeriği (Başlangıçta Gizli) -->
    <div class="page-wrapper px-4 sm:px-8 md:px-10 lg:px-12 py-10 hidden" id="report-container">
        
        <!-- Ay Değiştirici -->
        <div class="flex justify-center lg:justify-end mb-10">
            <div id="month-switcher" class="month-switcher"></div>
        </div>
        
        <!-- Başlık Bölümü -->
        <header class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-8 mb-12">
            <div class="flex items-center gap-4">
                <div class="h-16 w-16 rounded-2xl bg-gradient-to-br from-cyan-400 via-emerald-400 to-blue-500 flex items-center justify-center shadow-2xl shadow-cyan-500/30">
                    <span class="text-2xl font-bold text-slate-950">BD</span>
                </div>
                <div>
                    <p class="uppercase tracking-[0.4em] text-xs text-sky-200/80">Finansal Özet</p>
                    <h1 id="report-title" class="text-3xl sm:text-4xl lg:text-5xl font-bold gradient-text leading-tight">Boston Drink & Dessert | Cadde Şube Raporu</h1>
                </div>
            </div>
            <div class="glass-card flex flex-col sm:flex-row items-start sm:items-center gap-4 py-4 px-6">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-300">Rapor Dönemi</p>
                    <p class="text-lg font-semibold" id="report-period">Dönem: Yükleniyor...</p>
                </div>
                <div class="h-px sm:h-12 sm:w-px bg-slate-600/50 w-full sm:w-auto"></div>
                <div class="text-sm text-slate-300 max-w-xs leading-relaxed">
                    Cadde şubenin gelir, gider ve stok performansını tek ekranda izleyin. Grafik türünü değiştirerek farklı perspektifler yakalayın.
                </div>
            </div>
        </header>

        <!-- YENİ KONUM: YAPAY ZEKA ANALİZ BÖLÜMÜ -->
        <section id="ai-analysis-section" class="glass-card mb-14 hidden">
             <div class="flex items-center gap-4 mb-4">
                 <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center shadow-lg shadow-indigo-500/30">
                   <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#0F172A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.8-4.8 1.9 4.8 1.9L12 21l1.9-4.8 4.8-1.9-4.8-1.9L12 3z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                 </div>
                 <div>
                      <!-- DEĞİŞİKLİK: Gemini AI -> Umut AI -->
                      <p class="section-title text-indigo-200">UMUT AI</p>
                     <h2 class="text-2xl font-semibold text-white">Yapay Zeka Finansal Analizi</h2>
                 </div>
             </div>
             <div id="ai-analysis-loader" class="text-center py-8 hidden">
                 <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-400"></div>
                 <p class="mt-4 text-slate-300">Finansal veriler analiz ediliyor, lütfen bekleyin...</p>
             </div>
             <div id="ai-analysis-content" class="text-slate-300 leading-relaxed"></div>
        </section>

        <!-- KPI Kartları Bölümü -->
        <section id="overview" class="mb-14">
            <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
                <div class="flex items-center gap-6">
                    <h2 class="section-title text-slate-300">Genel Bakış</h2>
                    <span class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-slate-400 bg-slate-900/60 border border-slate-700/60 rounded-full px-4 py-1">Anlık Güncellenen Panoramik Özet</span>
                </div>
                <!-- DEĞİŞTİRİLEN BUTON -->
                <button id="runAiAnalysisBtn" class="ai-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    <!-- GÜNCELLENEN METİN -->
                    <span>Kapsamlı Yapay Zeka Analizi</span>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Net Gelir Kartı -->
                <div class="kpi-card">
                    <div class="kpi-header">
                        <p class="text-xs uppercase tracking-[0.3em] text-emerald-200/80">Net Gelir (Banka + Nakit)</p>
                        <span class="kpi-icon kpi-icon--income" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 19V5" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M6.75 10.25L12 5L17.25 10.25" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                    <p class="kpi-value font-bold text-emerald-200 mt-4" id="net-gelir">Yükleniyor...</p>
                </div>
                <!-- Toplam Gider Kartı -->
                <div class="kpi-card">
                    <div class="kpi-header">
                        <p class="text-xs uppercase tracking-[0.3em] text-rose-200/80">Toplam Gider (Banka + Nakit)</p>
                        <span class="kpi-icon kpi-icon--expense" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 5V19" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M17.25 13.75L12 19L6.75 13.75" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                    <p class="kpi-value font-bold text-rose-200 mt-4" id="toplam-gider">Yükleniyor...</p>
                </div>
                <!-- Net Kâr Kartı -->
                <div class="kpi-card">
                    <div class="kpi-header">
                        <p class="text-xs uppercase tracking-[0.3em] text-amber-200/80">Net Dönem Kârı (Nakit Akışı)</p>
                        <span id="net-kar-icon" class="kpi-icon kpi-icon--positive" role="img" aria-label="Kârda">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 15.5L9.5 11L13 14.5L19 8.5" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M19 12V8H15" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                    </div>
                    <p class="kpi-value font-bold text-amber-200 mt-4" id="net-kar">Yükleniyor...</p>
                </div>
            </div>
        </section>

        <!-- Grafik Bölümleri -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-14">
            <!-- Brüt Gelir Grafiği -->
            <section id="gross-income" class="glass-card">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                    <div>
                        <p class="section-title text-slate-300">Gelir Yapısı</p>
                        <h2 class="text-2xl font-semibold text-white">Brüt Gelirlerin Dağılımı</h2>
                        <p class="text-sm text-slate-400" id="gross-income-subtitle">Yükleniyor...</p>
                    </div>
                    <div class="chart-type-group" data-chart-toggle="grossIncomeChart">
                        <button class="chart-type-button" data-chart-target="grossIncomeChart" data-chart-type="doughnut">Halka</button>
                        <button class="chart-type-button" data-chart-target="grossIncomeChart" data-chart-type="bar">Çubuk</button>
                        <button class="chart-type-button" data-chart-target="grossIncomeChart" data-chart-type="polarArea">Kutupsal</button>
                    </div>
                </div>
                <div class="chart-container mb-6">
                    <canvas id="grossIncomeChart"></canvas>
                    <div class="total-label" id="grossIncomeTotal"></div>
                </div>
                <div id="gross-income-list" class="space-y-3"></div>
            </section>

            <!-- Net Gelir Grafiği -->
            <section id="net-income" class="glass-card">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                    <div>
                        <p class="section-title text-slate-300">Bankaya Yansıyan Gelir</p>
                        <h2 class="text-2xl font-semibold text-white">Net Gelirlerin Dağılımı</h2>
                        <p class="text-sm text-slate-400" id="net-income-subtitle">Yükleniyor...</p>
                    </div>
                    <div class="chart-type-group" data-chart-toggle="netIncomeChart">
                        <button class="chart-type-button" data-chart-target="netIncomeChart" data-chart-type="doughnut">Halka</button>
                        <button class="chart-type-button" data-chart-target="netIncomeChart" data-chart-type="bar">Çubuk</button>
                        <button class="chart-type-button" data-chart-target="netIncomeChart" data-chart-type="polarArea">Kutupsal</button>
                    </div>
                </div>
                <div class="chart-container mb-6">
                    <canvas id="netIncomeChart"></canvas>
                    <div class="total-label" id="netIncomeTotal"></div>
                </div>
                <div id="net-income-list" class="space-y-3"></div>
            </section>
        </div>

        <!-- Giderler Grafiği -->
        <section id="expenses" class="glass-card mb-14">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <p class="section-title text-slate-300">Operasyonel Giderler</p>
                    <h2 class="text-2xl font-semibold text-white">Giderlerin Dağılımı</h2>
                    <p class="text-sm text-slate-400">Tüm banka ve kasadan yapılan giderlerin detaylı dökümü.</p>
                </div>
                <div class="chart-type-group" data-chart-toggle="expenseChart">
                    <button class="chart-type-button" data-chart-target="expenseChart" data-chart-type="doughnut">Halka</button>
                    <button class="chart-type-button" data-chart-target="expenseChart" data-chart-type="bar">Çubuk</button>
                    <button class="chart-type-button" data-chart-target="expenseChart" data-chart-type="polarArea">Kutupsal</button>
                </div>
            </div>
            <div class="chart-container mb-6">
                <canvas id="expenseChart"></canvas>
                <div class="total-label" id="expenseTotal"></div>
            </div>
            <div id="expense-list" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </section>

        <!-- Çikolata Analizi -->
        <section id="chocolate-analysis" class="glass-card mb-14">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <p class="section-title text-slate-300">Hammadde & Stoklar</p>
                    <h2 class="text-2xl font-semibold text-white">Çikolata Kullanım ve Gider Analizi</h2>
                    <p class="text-sm text-slate-400">Kullanılan çikolataların miktar (KG) ve toplam maliyet (₺) dökümü.</p>
                </div>
                <div class="chart-type-group" data-chart-toggle="chocolateChart">
                    <button class="chart-type-button" data-chart-target="chocolateChart" data-chart-type="doughnut">Halka</button>
                    <button class="chart-type-button" data-chart-target="chocolateChart" data-chart-type="bar">Çubuk</button>
                    <button class="chart-type-button" data-chart-target="chocolateChart" data-chart-type="polarArea">Kutupsal</button>
                </div>
            </div>
            <div class="chart-container mb-6">
                <canvas id="chocolateChart"></canvas>
                <div class="total-label" id="chocolateTotal"></div>
            </div>
            <div id="chocolate-list" class="space-y-3"></div>
        </section>

        <!-- Yemek Kartları Analizi -->
        <section id="food-cards" class="glass-card mb-14">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <p class="section-title text-slate-300">İK & Sosyal Haklar</p>
                    <h2 class="text-2xl font-semibold text-white">Personel Yemek Kartları Analizi</h2>
                    <p class="text-sm text-slate-400">Personele ait yemek kartlarına yüklenen toplam tutarlar.</p>
                </div>
                <div class="chart-type-group" data-chart-toggle="foodCardChart">
                    <button class="chart-type-button" data-chart-target="foodCardChart" data-chart-type="doughnut">Halka</button>
                    <button class="chart-type-button" data-chart-target="foodCardChart" data-chart-type="bar">Çubuk</button>
                    <button class="chart-type-button" data-chart-target="foodCardChart" data-chart-type="polarArea">Kutupsal</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="chart-container">
                    <canvas id="foodCardChart"></canvas>
                    <div class="total-label" id="foodCardTotal"></div>
                </div>
                <div id="food-card-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 border-l border-slate-700/60 pl-4">
                    <!-- Liste JavaScript ile doldurulacak -->
                </div>
            </div>
        </section>

        <!-- Sevkiyat Detayları -->
        <section id="shipment" class="glass-card mb-14">
            <div class="flex flex-col gap-3 mb-6">
                <p class="section-title text-slate-300">Tedarik Zinciri</p>
                <h2 class="text-2xl font-semibold text-white">Genel Merkez Sevkiyat Detayları</h2>
                <p class="text-sm text-slate-400">Dönem içinde genel merkezden yapılan ürün sevkiyatlarının dökümü.</p>
            </div>
            <div id="shipment-list" class="space-y-3">
                <!-- Sevkiyat listesi JavaScript ile doldurulacak -->
            </div>
            <div id="shipment-total-container" class="mt-6 pt-6 border-t border-slate-700/70 text-right">
                <span class="text-sm uppercase tracking-[0.3em] text-slate-400">Sevkiyat Toplam Tutarı</span>
                <p id="shipment-total" class="text-3xl font-bold text-emerald-200 mt-2">Yükleniyor...</p>
            </div>
        </section>

        <!-- Nakit Akışı Bölümü -->
        <section id="cashflow" class="glass-card mb-14">
            <div class="flex flex-col gap-3 mb-6">
                <p class="section-title text-slate-300">Likidite Nabzı</p>
                <h2 class="text-2xl font-semibold text-white">Nakit Akışı ve Banka Analizi</h2>
                <p class="text-sm text-slate-400">Bankaya yatan net tutarlar ile tüm giderler arasındaki fark.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="space-y-5">
                    <h3 class="font-semibold text-lg text-white">Online Platform Komisyon Analizi</h3>
                    <div id="online-commission-list" class="space-y-4"></div>
                    <div class="mt-6 p-6 rounded-2xl bg-gradient-to-br from-sky-400/10 via-cyan-400/10 to-emerald-400/10 border border-sky-300/20 shadow-lg shadow-sky-500/10">
                        <h4 class="font-semibold text-sky-200" id="total-commission-header"></h4>
                        <p class="text-sm text-slate-200/80 leading-relaxed" id="total-commission-text"></p>
                    </div>
                </div>
                <div class="space-y-5">
                    <h3 class="font-semibold text-lg text-white">Dönem Sonu Finansal Durum</h3>
                    <div id="financial-status-list" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- Yönetici Paneli -->
        <section id="admin-panel" class="glass-card mt-12 mb-12">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-6">
                <div>
                    <p class="section-title text-slate-300">Veri Yönetimi</p>
                    <h2 class="text-2xl font-semibold text-white">Gizli Yönetici Paneli</h2>
                    <p class="text-sm text-slate-400 mt-2 max-w-xl">Yetkili kullanıcılar tek tuşla rapor veri setini güncelleyebilir. Güvenli bağlantı üzerinden Firebase ile eş zamanlı çalışır.</p>
                </div>
                <button id="updateDataBtn" class="px-6 py-3 rounded-full font-semibold uppercase tracking-[0.3em] bg-gradient-to-r from-sky-500 to-emerald-400 text-slate-950 shadow-xl shadow-emerald-500/30 hover:shadow-emerald-400/40 transition duration-300">Örnek Veriyi Güncelle</button>
            </div>
        </section>

        <!-- Alt Bilgi -->
        <footer class="text-center text-xs text-slate-400/80 mt-16 pb-10">
            <p>Bu rapor, güvenli veri kaynaklarına dayanarak oluşturulmuştur ve finansal danışmanlık yerine geçmez.</p>
            <p>Rapor Tarihi: 10 Ekim 2025</p>
        </footer>
    </div>

    <!-- JavaScript Modülü -->
    <script type="module">
        // YENİ AUTH VE FIRESTORE MODÜLLERİ EKLENDİ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            sendSignInLinkToEmail,     // Yeni
            isSignInWithEmailLink,    // Yeni
            signInWithEmailLink      // Yeni
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            setDoc, 
            setLogLevel,
            getDoc             // Yeni
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase ve Uygulama Ayarları ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // PLATFORMUN YANLIŞ PROJE ENJEKTE ETMESİNE KARŞI MANUEL ÇÖZÜM
        // const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); 
        
        // SİZİN GERÇEK PROJE BİLGİLERİNİZLE MANUEL OLARAK AYARLANDI
        const firebaseConfig = {
            apiKey: "AIzaSyCfwKWMQrTMPrllS6ezXJ98GMZXpIaCnf8", // Daha önce paylaştığınız API anahtarınız
            authDomain: "boston-ee886.firebaseapp.com",
            projectId: "boston-ee886", // Ekran görüntülerinizden alınan proje kimliği
            storageBucket: "boston-ee886.appspot.com"
            // Diğer bilgiler (messagingSenderId, appId) bu uygulama için zorunlu değil.
        };
        // --- MANUEL ÇÖZÜM SONU ---

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- HATA AYIKLAMA: HANGİ PROJEYE BAĞLANIYORUZ? ---
        console.log("BAĞLANILAN PROJE KİMLİĞİ:", firebaseConfig.projectId || "Proje Kimliği Bulunamadı!");
        // --- HATA AYIKLAMA SONU ---

        let app;
        let db;
        let auth;
        let userId;
        let unsubscribeReport = () => {}; // Rapor dinleyicisini tutar
        let charts = {};
        const chartStates = {};
        const radialChartTypes = ['doughnut', 'polarArea', 'pie'];
        const grossIncomeColors = ['#2563EB', '#F97316', '#22C55E', '#A855F7', '#FACC15'];
        const netIncomeColors = ['#2563EB', '#F97316', '#22C55E', '#A855F7', '#FACC15', '#EC4899', '#14B8A6'];

        // --- DOM Elementleri ---
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const authButton = document.getElementById('auth-button');
        const emailInput = document.getElementById('email-input');
        const authMessage = document.getElementById('auth-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const reportContainer = document.getElementById('report-container');

        // --- Para Formatlayıcı ---
        const formatter = new Intl.NumberFormat('tr-TR', {
            style: 'currency',
            currency: 'TRY',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        // --- Yeni Rapor Veri Yolu ---
        // Veriyi "public" alandan okuyacak şekilde güncellendi
        const getReportDocRef = () => {
            if (!appId) {
                console.error("Uygulama Kimliği (appId) bulunamadı. 'default-app-id' kullanılıyor.");
                // 'default-app-id' ile devam et, bu sayede admin paneli en azından veri yazmayı dener
            }
            // appId tanımsız olsa bile, hata ayıklama için 'default-app-id' kullan
            const effectiveAppId = appId || 'default-app-id';
            return doc(db, 'artifacts', effectiveAppId, 'public', 'reportData');
        }

        // --- Veri Kümesi (Sample Data) ---
        // Bu veriler, butona tıklandığında Firestore'a yazılır
        const sampleReportData = {
            activeMonth: 'ekim2025',
            reports: {
                ekim2025: {
                    name: 'Ekim 2025',
                    period: '01.10.2025 - 31.10.2025',
                    kpi: {
                        brutGelir: 1850200.0,
                        toplamGider: 1420100.50,
                        netKar: 250150.75 // (brutGelir - toplamGider) değil, net gelir - toplam gider farkı
                    },
                    grossIncome: {
                        labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit'],
                        data: [810500, 600100, 180300, 150200, 109100]
                    },
                    netIncome: {
                        labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit', 'Set Card', 'Multinet'],
                        data: [810500, 438073, 115392, 102136, 109100, 45000, 30000]
                    },
                    expenses: {
                        labels: ['Personel Giderleri', 'Gıda Hammadde (Tedarikçi)', 'Genel Merkez Sevkiyat', 'Kira', 'Online Platform Komisyonları', 'Yemek Kartları (Personel)', 'Faturalar (Elk, Su, Dgaz)', 'Ambalaj ve Sarf', 'Diğer İşletme Giderleri'],
                        data: [310000, 280500, 250150, 180000, 154699, 65000, 48500, 41251.50, 90000]
                    },
                    chocolateAnalysis: {
                        labels: ['Beyaz Çikolata (KG)', 'Sütlü Çikolata (KG)', 'Bitter Çikolata (KG)', 'Ruby Çikolata (KG)', 'Nutella (KG)'],
                        data: [150, 200, 180, 50, 80], // Miktar (KG)
                        costs: [45000, 50000, 48600, 17500, 12000] // Maliyet (TL)
                    },
                    foodCards: {
                        labels: ['Umut (Müdür)', 'Ayşe (Barista)', 'Fatma (Barista)', 'Mehmet (Komi)', 'Zeynep (Mutfak)', 'Ali (Mutfak)', 'Deniz (Part-time)'],
                        data: [10000, 8000, 8000, 7500, 9000, 9000, 6000]
                    },
                    shipments: {
                        labels: ['Donuk Ürünler (Cheesecake, Brownie vb.)', 'İçecek Şurupları ve Soslar', 'Markalı Ambalaj Ürünleri (Bardak, Poşet)', 'Kahve Çekirdekleri (Öğütülmüş)'],
                        data: [120000, 45000, 55150, 30000]
                    },
                    cashflow: {
                        totalNetIncome: 1650201, // (netIncome.data toplamı)
                        totalExpenses: 1420100.50, // (expenses.data toplamı)
                        netProfit: 230100.5, // (totalNetIncome - totalExpenses)
                        commissions: { // (grossIncome - netIncome)
                            'Yemeksepeti': 162027,
                            'Getir': 64908,
                            'Trendyol': 48064
                        }
                    }
                },
                agustos2025: { // Önceki aydan veri
                    name: 'Ağustos 2025',
                    period: '01.08.2025 - 04.09.2025',
                    kpi: {
                        brutGelir: 1704018.0,
                        toplamGider: 1347540.82,
                        netKar: 181923.31 
                    },
                    grossIncome: {
                        labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit'],
                        data: [728958, 547510, 162820, 142555, 122175]
                    },
                    netIncome: {
                        labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit', 'Set Card', 'Multinet'],
                        data: [729092.33, 396173.05, 104019.71, 96789.04, 122175, 40000, 25000]
                    },
                    expenses: {
                        labels: ['Personel Giderleri', 'Gıda Hammadde (Tedarikçi)', 'Genel Merkez Sevkiyat', 'Kira', 'Online Platform Komisyonları', 'Yemek Kartları (Personel)', 'Faturalar (Elk, Su, Dgaz)', 'Ambalaj ve Sarf', 'Diğer İşletme Giderleri'],
                        data: [300000, 250100, 230000, 180000, 151550.9, 58000, 45300, 37589.92, 95000]
                    },
                    chocolateAnalysis: {
                        labels: ['Beyaz Çikolata (KG)', 'Sütlü Çikolata (KG)', 'Bitter Çikolata (KG)', 'Ruby Çikolata (KG)', 'Nutella (KG)'],
                        data: [130, 180, 160, 40, 70],
                        costs: [39000, 45000, 43200, 14000, 10500]
                    },
                    foodCards: {
                        labels: ['Umut (Müdür)', 'Ayşe (Barista)', 'Fatma (Barista)', 'Mehmet (Komi)', 'Zeynep (Mutfak)', 'Ali (Mutfak)', 'Deniz (Part-time)'],
                        data: [9500, 7500, 7500, 7000, 8500, 8500, 5500]
                    },
                    shipments: {
                        labels: ['Donuk Ürünler (Cheesecake, Brownie vb.)', 'İçecek Şurupları ve Soslar', 'Markalı Ambalaj Ürünleri (Bardak, Poşet)', 'Kahve Çekirdekleri (Öğütülmüş)'],
                        data: [110000, 40000, 50000, 30000]
                    },
                    cashflow: {
                        totalNetIncome: 1513249.13,
                        totalExpenses: 1347540.82,
                        netProfit: 165708.31,
                        commissions: {
                            'Yemeksepeti': 151336.95,
                            'Getir': 58800.29,
                            'Trendyol': 45765.96
                        }
                    }
                },
                // Eylül 2025 verisi (biraz daha düşük bir ay)
                eylul2025: {
                    name: 'Eylül 2025',
                    period: '01.09.2025 - 30.09.2025',
                    kpi: {
                        brutGelir: 1680000.0,
                        toplamGider: 1390000.0,
                        netKar: 120500.0
                    },
                    grossIncome: {
                        labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit'],
                        data: [750000, 580000, 150000, 100000, 100000]
                    },
                    netIncome: {
                        labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit', 'Set Card', 'Multinet'],
                        data: [750000, 417600, 96000, 68000, 100000, 42000, 27000]
                    },
                    expenses: {
                        labels: ['Personel Giderleri', 'Gıda Hammadde (Tedarikçi)', 'Genel Merkez Sevkiyat', 'Kira', 'Online Platform Komisyonları', 'Yemek Kartları (Personel)', 'Faturalar (Elk, Su, Dgaz)', 'Ambalaj ve Sarf', 'Diğer İşletme Giderleri'],
                        data: [305000, 260000, 240000, 180000, 148400, 60000, 46000, 39500, 111100]
                    },
                    chocolateAnalysis: {
                        labels: ['Beyaz Çikolata (KG)', 'Sütlü Çikolata (KG)', 'Bitter Çikolata (KG)', 'Ruby Çikolata (KG)', 'Nutella (KG)'],
                        data: [140, 190, 170, 45, 75],
                        costs: [42000, 47500, 45900, 15750, 11250]
                    },
                    foodCards: {
                        labels: ['Umut (Müdür)', 'Ayşe (Barista)', 'Fatma (Barista)', 'Mehmet (Komi)', 'Zeynep (Mutfak)', 'Ali (Mutfak)', 'Deniz (Part-time)'],
                        data: [9800, 7800, 7800, 7300, 8800, 8800, 5800]
                    },
                    shipments: {
                        labels: ['Donuk Ürünler (Cheesecake, Brownie vb.)', 'İçecek Şurupları ve Soslar', 'Markalı Ambalaj Ürünleri (Bardak, Poşet)', 'Kahve Çekirdekleri (Öğütülmüş)'],
                        data: [115000, 42000, 53000, 30000]
                    },
                    cashflow: {
                        totalNetIncome: 1500600,
                        totalExpenses: 1390000,
                        netProfit: 110600,
                        commissions: {
                            'Yemeksepeti': 162400,
                            'Getir': 54000,
                            'Trendyol': 32000
                        }
                    }
                }
            }
        };

        // --- YARDIMCI FONKSİYONLAR ---

        /**
         * Verilen yüzdeye göre renk tonu (açıklık) ayarlar.
         * @param {string} color - Temel hex renk kodu
         * @param {number} percent - Açıklık yüzdesi (örn: 20, -10)
         * @returns {string} - Yeni hex renk kodu
         */
        const shadeColor = (color, percent) => {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);
            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);
            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;
            const RR = ((R.toString(16).length === 1) ? "0" + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length === 1) ? "0" + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length === 1) ? "0" + B.toString(16) : B.toString(16));
            return "#" + RR + GG + BB;
        };

        /**
         * Verilen veriye göre dinamik renk paleti oluşturur.
         * @param {string[]} baseColors - Temel renk dizisi
         * @param {number} count - İstenen renk sayısı
         * @returns {string[]} - Oluşturulan renk dizisi
         */
        const createColorPalette = (baseColors, count) => {
            const palette = [];
            for (let i = 0; i < count; i++) {
                const baseColor = baseColors[i % baseColors.length];
                const shadePercent = Math.floor(i / baseColors.length) * -15; // Her döngüde %15 koyulaştır
                palette.push(shadeColor(baseColor, shadePercent));
            }
            return palette;
        };

        /**
         * Grafik listeleri için HTML elemanı oluşturur (Yeni tasarım).
         * @param {string} label - Etiket
         * @param {number} value - Değer (para birimi)
         * @param {number} percentage - Yüzde
         * @param {string} color - Renk kodu
         * @returns {string} - Oluşturulan HTML
         */
        const createListItemHTML = (label, value, percentage, color) => `
            <div class="flex items-center justify-between gap-3 p-3 rounded-xl transition-all duration-200 hover:bg-slate-800/60">
                <div class="flex items-center gap-3 min-w-0">
                    <span class="h-3 w-3 rounded-full" style="background-color: ${color}; box-shadow: 0 0 12px 1px ${color};"></span>
                    <span class="text-sm font-medium text-slate-200 truncate" title="${label}">${label}</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-semibold text-slate-100 whitespace-nowrap">${formatter.format(value)}</span>
                    <span class="text-xs font-mono text-cyan-300 bg-cyan-900/50 border border-cyan-700/60 rounded-full px-2 py-0.5 w-[60px] text-center">${percentage.toFixed(1)}%</span>
                </div>
            </div>
        `;

        /**
         * Nakit akışı ve sevkiyat listeleri için HTML elemanı oluşturur.
         * @param {string} label - Etiket
         * @param {number} value - Değer
         * @param {string} [colorClass="text-emerald-200"] - Tailwind renk sınıfı
         * @returns {string} - Oluşturulan HTML
         */
        const createDetailItemHTML = (label, value, colorClass = "text-emerald-200") => `
            <div class="flex items-center justify-between gap-4 p-4 rounded-xl bg-slate-900/60 border border-slate-700/50 hover:border-slate-600/80 transition-all duration-200">
                <span class="text-sm font-medium text-slate-300">${label}</span>
                <span class="text-lg font-semibold ${colorClass}">${formatter.format(value)}</span>
            </div>
        `;

        // --- CHART.JS FONKSİYONLARI ---

        /**
         * Genel Chart.js ayarları.
         */
        Chart.defaults.color = 'rgba(203, 213, 225, 0.7)'; // Eksen renkleri
        Chart.defaults.font.family = "'Inter', 'sans-serif'";
        Chart.defaults.font.weight = '500';
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.padding = 20;
        Chart.defaults.plugins.tooltip.enabled = true;
        Chart.defaults.plugins.tooltip.mode = 'index';
        Chart.defaults.plugins.tooltip.intersect = false;
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.85)';
        Chart.defaults.plugins.tooltip.borderColor = 'rgba(148, 163, 184, 0.25)';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: '700' };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
        Chart.defaults.plugins.tooltip.padding = 12;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.plugins.tooltip.displayColors = true;
        Chart.defaults.plugins.tooltip.callbacks.label = (context) => {
            let label = context.dataset.label || '';
            if (label) {
                label += ': ';
            }
            if (context.parsed.y !== null) {
                label += formatter.format(context.parsed.y);
            } else if (context.parsed.r !== null) {
                label += formatter.format(context.parsed.r);
            } else {
                label += formatter.format(context.parsed);
            }
            return label;
        };


        /**
         * Yeni bir grafik oluşturur veya mevcut grafiği günceller.
         * @param {string} chartId - Canvas elementinin ID'si
         * @param {string} type - Grafik türü (doughnut, bar, polarArea)
         * @param {string[]} labels - Etiketler
         * @param {number[]} data - Veri
         * @param {string[]} [colors] - (Opsiyonel) Renkler
         */
        const createOrUpdateChart = (chartId, type, labels, data, colors) => {
            const ctx = document.getElementById(chartId);
            if (!ctx) return;

            const chartInstance = charts[chartId];
            const baseColors = colors || ['#38BDF8', '#34D399', '#F472B6', '#FACC15', '#A78BFA', '#F87171', '#60A5FA'];
            const palette = createColorPalette(baseColors, data.length);

            const isRadial = radialChartTypes.includes(type);
            const total = data.reduce((a, b) => a + b, 0);
            
            // Veriyi sıralama (Çubuk grafik hariç)
            let sortedData = [];
            let sortedLabels = [];
            let sortedColors = [];

            if (type !== 'bar') {
                const combined = data.map((value, index) => ({
                    value,
                    label: labels[index],
                    color: palette[index]
                })).sort((a, b) => b.value - a.value); // Büyükten küçüğe sırala

                sortedData = combined.map(item => item.value);
                sortedLabels = combined.map(item => item.label);
                sortedColors = combined.map(item => item.color);
            } else {
                sortedData = data;
                sortedLabels = labels;
                sortedColors = palette;
            }

            const chartData = {
                labels: sortedLabels,
                datasets: [{
                    label: 'Tutar (₺)',
                    data: sortedData,
                    backgroundColor: (type === 'bar') ? sortedColors[0] : sortedColors, // Çubuk grafikte tek renk
                    borderColor: (type === 'bar') ? sortedColors[0] : (isRadial ? 'rgba(15, 23, 42, 0.6)' : sortedColors),
                    borderWidth: (isRadial ? 2 : (type === 'bar' ? 0 : 3)),
                    borderRadius: (type === 'bar') ? 6 : 0,
                    cutout: (isRadial ? '70%' : '0%'),
                    hoverOffset: 12,
                    tension: 0.1, // Line chart (kullanılmıyor ama gelecekte lazım olabilir)
                    fill: false // Line chart
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 800,
                    easing: 'easeInOutCubic'
                },
                scales: {
                    y: {
                        display: !isRadial,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            borderColor: 'rgba(148, 163, 184, 0.1)'
                        },
                        ticks: {
                            callback: (value) => `${value / 1000}k ₺`
                        }
                    },
                    x: {
                        display: !isRadial,
                        grid: {
                            display: false
                        },
                         ticks: {
                            maxRotation: 0,
                            minRotation: 0,
                            callback: function(value, index, values) {
                                // Etiketleri kısalt
                                const label = this.getLabelForValue(value);
                                return label.length > 15 ? label.substring(0, 15) + '...' : label;
                            }
                        }
                    },
                    r: { // PolarArea için
                        display: isRadial,
                        grid: { color: 'rgba(148, 163, 184, 0.15)' },
                        ticks: {
                            display: false,
                            backdropColor: 'transparent'
                        },
                        pointLabels: {
                            display: true,
                            centerPointLabels: true,
                            font: { size: 11 },
                            color: 'rgba(226, 232, 240, 0.8)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: !isRadial && type !== 'bar', // Sadece line/radar için
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                let label = context.label || '';
                                let value = context.parsed.y ?? context.parsed.r ?? context.parsed;
                                return `${label}: ${formatter.format(value)} (${(value / total * 100).toFixed(1)}%)`;
                            }
                        }
                    }
                }
            };
            
            // Halka (Doughnut) grafiğe özel ayarlar
            if (type === 'doughnut') {
                options.plugins.legend.display = false;
                options.scales.r.pointLabels.display = false; // PolarArea'dan kalan ayarı kapat
            }
            // PolarArea'ya özel ayarlar
            if (type === 'polarArea') {
                 options.plugins.legend.display = false;
            }
            // Bar grafiğe özel ayarlar
            if (type === 'bar') {
                options.plugins.legend.display = false;
            }

            // Toplam etiketini güncelle
            const totalEl = document.getElementById(chartId + 'Total');
            if (totalEl && isRadial) {
                totalEl.innerHTML = `<span class="block text-xs uppercase tracking-[0.2em] text-slate-300">Toplam</span>${formatter.format(total)}`;
            } else if (totalEl) {
                totalEl.innerHTML = '';
            }

            // Grafik listesini güncelle (Sıralı veriye göre)
            const listEl = document.getElementById(chartId.replace('Chart', '-list'));
            if (listEl) {
                listEl.innerHTML = sortedData.map((value, index) => {
                    const percentage = (value / total) * 100;
                    return createListItemHTML(sortedLabels[index], value, percentage, sortedColors[index]);
                }).join('');
            }

            // Grafiği oluştur/güncelle
            if (chartInstance) {
                // Eğer grafik türü değiştiyse, eski grafiği yok et ve yenisini oluştur
                if (chartInstance.config.type !== type) {
                    chartInstance.destroy();
                    charts[chartId] = new Chart(ctx, { type, data: chartData, options });
                } else {
                    // Sadece veriyi ve seçenekleri güncelle
                    chartInstance.data = chartData;
                    chartInstance.options = options;
                    chartInstance.update();
                }
            } else {
                charts[chartId] = new Chart(ctx, { type, data: chartData, options });
            }
            
            // Grafik durumunu kaydet
            chartStates[chartId] = type;
        };


        /**
         * Rapor verisini alır ve tüm UI'ı günceller.
         * @param {object} reportData - Firestore'dan gelen tüm rapor verisi
         * @param {string} monthKey - Gösterilecek ayın anahtarı (örn: 'ekim2025')
         */
        const updateDashboard = (reportData, monthKey) => {
            const data = reportData.reports[monthKey];
            if (!data) {
                console.error(`Rapor verisi bulunamadı: ${monthKey}`);
                authMessage.textContent = `Rapor verisi bulunamadı: ${monthKey}`;
                authMessage.className = 'auth-message-error';
                return;
            }

            // Ay değiştiriciyi güncelle
            const monthSwitcher = document.getElementById('month-switcher');
            monthSwitcher.innerHTML = Object.keys(reportData.reports)
                .sort((a, b) => new Date(a.split(' ')[1], ['ocak', 'şubat', 'mart', 'nisan', 'mayıs', 'haziran', 'temmuz', 'ağustos', 'eylül', 'ekim', 'kasım', 'aralık'].indexOf(a.split(' ')[0].toLowerCase())) - new Date(b.split(' ')[1], ['ocak', 'şubat', 'mart', 'nisan', 'mayıs', 'haziran', 'temmuz', 'ağustos', 'eylül', 'ekim', 'kasım', 'aralık'].indexOf(b.split(' ')[0].toLowerCase()))) // Basitçe sıralama, gerekirse iyileştir
                .map(key => {
                    const name = reportData.reports[key].name;
                    // Ay isimlerini kısalt (örn: "Ekim 2025" -> "Eki '25")
                    const shortName = name.split(' ')[0].substring(0, 3) + " '" + name.split(' ')[1].substring(2);
                    return `<button class="month-button" data-month-key="${key}" data-active="${key === monthKey}"><span>${shortName}</span></button>`;
                }).join('');

            // Başlık ve Rapor Dönemi
            document.getElementById('report-period').textContent = data.period;
            document.getElementById('report-title').textContent = `Boston Drink & Dessert | ${data.name} Raporu`;
            document.getElementById('gross-income-subtitle').textContent = `${data.name} dönemi brüt satışların dökümü.`;
            document.getElementById('net-income-subtitle').textContent = `${data.name} dönemi platform kesintileri sonrası net döküm.`;

            // KPI Kartları
            document.getElementById('net-gelir').textContent = formatter.format(data.kpi.brutGelir); // Brüt gelir olarak güncellendi (Net Gelir kafa karıştırıcı olabilir)
            document.getElementById('toplam-gider').textContent = formatter.format(data.kpi.toplamGider);
            document.getElementById('net-kar').textContent = formatter.format(data.kpi.netKar);
            
            // Net Kâr ikonu
            const netKarIcon = document.getElementById('net-kar-icon');
            if (data.kpi.netKar > 0) {
                netKarIcon.className = 'kpi-icon kpi-icon--positive';
                netKarIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 15.5L9.5 11L13 14.5L19 8.5" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" /><path d="M19 12V8H15" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" /></svg>`;
                netKarIcon.setAttribute('aria-label', 'Kârda');
            } else {
                netKarIcon.className = 'kpi-icon kpi-icon--negative';
                netKarIcon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 8.5L9.5 13L13 9.5L19 15.5" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 12V16H15" stroke="#0F172A" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                netKarIcon.setAttribute('aria-label', 'Zararda');
            }

            // Brüt Gelir Grafiği
            createOrUpdateChart(
                'grossIncomeChart',
                chartStates['grossIncomeChart'] || 'doughnut',
                data.grossIncome.labels,
                data.grossIncome.data,
                grossIncomeColors
            );

            // Net Gelir Grafiği
            createOrUpdateChart(
                'netIncomeChart',
                chartStates['netIncomeChart'] || 'doughnut',
                data.netIncome.labels,
                data.netIncome.data,
                netIncomeColors
            );

            // Giderler Grafiği
            createOrUpdateChart(
                'expenseChart',
                chartStates['expenseChart'] || 'doughnut',
                data.expenses.labels,
                data.expenses.data
            );
            
            // Çikolata Analizi (Maliyetleri göster)
            createOrUpdateChart(
                'chocolateChart',
                chartStates['chocolateChart'] || 'doughnut',
                data.chocolateAnalysis.labels,
                data.chocolateAnalysis.costs // Maliyetleri (TL) grafiğe dök
            );
            // Çikolata Listesini (KG ve TL) güncelle
            const chocolateListEl = document.getElementById('chocolate-list');
            const totalKg = data.chocolateAnalysis.data.reduce((a, b) => a + b, 0);
            const totalCost = data.chocolateAnalysis.costs.reduce((a, b) => a + b, 0);
            chocolateListEl.innerHTML = data.chocolateAnalysis.labels.map((label, index) => {
                const kg = data.chocolateAnalysis.data[index];
                const cost = data.chocolateAnalysis.costs[index];
                const percentage = (cost / totalCost) * 100;
                const newLabel = `${label.replace(' (KG)', '')} (${kg} kg)`;
                return createListItemHTML(newLabel, cost, percentage, charts['chocolateChart'].data.datasets[0].backgroundColor[index]);
            }).join('');


            // Yemek Kartları Grafiği
            createOrUpdateChart(
                'foodCardChart',
                chartStates['foodCardChart'] || 'doughnut',
                data.foodCards.labels,
                data.foodCards.data
            );
            // Yemek kartları listesini güncelle (Sıralı)
            const foodCardListEl = document.getElementById('food-card-list');
            const totalFoodCard = data.foodCards.data.reduce((a, b) => a + b, 0);
            const foodCardChartInstance = charts['foodCardChart'];
            // Grafikten alınan sıralı veriyi kullan
            foodCardListEl.innerHTML = foodCardChartInstance.data.datasets[0].data.map((value, index) => {
                const label = foodCardChartInstance.data.labels[index];
                const color = foodCardChartInstance.data.datasets[0].backgroundColor[index];
                const percentage = (value / totalFoodCard) * 100;
                return createListItemHTML(label, value, percentage, color);
            }).join('');

            // Sevkiyat Detayları
            const shipmentListEl = document.getElementById('shipment-list');
            const shipmentTotal = data.shipments.data.reduce((a, b) => a + b, 0);
            shipmentListEl.innerHTML = data.shipments.labels.map((label, index) => {
                return createDetailItemHTML(label, data.shipments.data[index]);
            }).join('');
            document.getElementById('shipment-total').textContent = formatter.format(shipmentTotal);

            // Nakit Akışı ve Komisyon Analizi
            const commissionListEl = document.getElementById('online-commission-list');
            const cashflowListEl = document.getElementById('financial-status-list');
            const { totalNetIncome, totalExpenses, netProfit, commissions } = data.cashflow;

            let commissionHTML = '';
            for (const [platform, commission] of Object.entries(commissions)) {
                commissionHTML += createDetailItemHTML(platform + ' Komisyon Kesintisi', commission, 'text-amber-300');
            }
            commissionListEl.innerHTML = commissionHTML;
            
            const totalCommission = Object.values(commissions).reduce((a, b) => a + b, 0);
            document.getElementById('total-commission-header').textContent = `Toplam ${formatter.format(totalCommission)} Komisyon Kesintisi`;
            document.getElementById('total-commission-text').textContent = `Online platformlar (Yemeksepeti, Getir, Trendyol) brüt satışlar üzerinden dönemsel olarak toplam bu tutarı kesmiştir. Bu tutar, Giderler grafiğindeki 'Online Platform Komisyonları' kalemi ile eşleşmektedir.`;

            cashflowListEl.innerHTML = `
                ${createDetailItemHTML('Bankaya Yansıyan Net Gelirler', totalNetIncome, 'text-emerald-200')}
                ${createDetailItemHTML('Tüm Giderler (Banka + Nakit)', totalExpenses, 'text-rose-300')}
                <div class="mt-4 pt-4 border-t border-slate-700/70">
                ${createDetailItemHTML('Dönem Sonu Net Kâr (Nakit Akışı)', netProfit, 'text-sky-300')}
                </div>
            `;
            
            // AI Analiz bölümünü gizle (kullanıcı isterse açar)
            document.getElementById('ai-analysis-section').classList.add('hidden');
            document.getElementById('ai-analysis-content').innerHTML = '';
            document.getElementById('runAiAnalysisBtn').disabled = false;
        };


        // --- GRAFİK TÜRÜ DEĞİŞTİRİCİ ---
        const setupChartToggleListeners = () => {
            document.querySelectorAll('.chart-type-group').forEach(group => {
                group.addEventListener('click', (e) => {
                    const button = e.target.closest('.chart-type-button');
                    if (!button) return;

                    const chartId = button.dataset.chartTarget;
                    const newType = button.dataset.chartType;

                    // Butonların aktif durumunu güncelle
                    group.querySelectorAll('.chart-type-button').forEach(btn => {
                        btn.dataset.active = (btn === button);
                    });

                    // Grafiği yeniden çiz
                    const chartInstance = charts[chartId];
                    if (chartInstance) {
                        createOrUpdateChart(
                            chartId,
                            newType,
                            chartInstance.data.labels, // Mevcut etiketleri kullan
                            chartInstance.data.datasets[0].data, // Mevcut veriyi kullan
                            chartId === 'grossIncomeChart' ? grossIncomeColors : (chartId === 'netIncomeChart' ? netIncomeColors : undefined)
                        );
                    }
                });
            });

            // Başlangıçta tüm 'doughnut' butonlarını aktif et
            document.querySelectorAll('.chart-type-button[data-chart-type="doughnut"]').forEach(btn => {
                btn.dataset.active = 'true';
            });
        };

        // --- AY DEĞİŞTİRİCİ ---
        const setupMonthSwitcherListener = (reportData) => {
            document.getElementById('month-switcher').addEventListener('click', (e) => {
                const button = e.target.closest('.month-button');
                if (!button || button.dataset.active === 'true') return;

                const monthKey = button.dataset.monthKey;
                // AI analizi hariç tüm dashboard'u güncelle
                updateDashboard(reportData, monthKey);
            });
        };

        // --- YAPAY ZEKA ANALİZ FONKSİYONU ---
        const handleAiAnalysis = async (reportData, monthKey) => {
            const aiButton = document.getElementById('runAiAnalysisBtn');
            const aiSection = document.getElementById('ai-analysis-section');
            const aiLoader = document.getElementById('ai-analysis-loader');
            const aiContent = document.getElementById('ai-analysis-content');

            aiButton.disabled = true;
            aiButton.querySelector('span').textContent = 'Analiz Başlatılıyor...';
            aiButton.insertAdjacentHTML('afterbegin', '<div class="spinner"></div>');
            
            aiSection.classList.remove('hidden');
            aiLoader.classList.remove('hidden');
            aiContent.innerHTML = '';

            // API'ye gönderilecek veriyi hazırla
            const data = reportData.reports[monthKey];
            const previousMonthKey = Object.keys(reportData.reports).find((k, i, arr) => arr[i+1] === monthKey);
            const previousData = previousMonthKey ? reportData.reports[previousMonthKey] : null;

            // Veriyi sadeleştir
            const simplifiedData = {
                donem: data.name,
                kpi: data.kpi,
                gelirler: data.netIncome,
                giderler: data.expenses,
                hammadde: data.chocolateAnalysis,
                oncekiDonem: previousData ? { donem: previousData.name, kpi: previousData.kpi } : null
            };
            
            const systemPrompt = `
                Sen, Boston Drink & Dessert (Umut AI) adlı şirketin kıdemli finansal analistisin. 
                Sana JSON formatında bir şubenin bu aylık ve (varsa) önceki aylık finansal verileri verilecek. 
                Görevin, bu verileri analiz ederek net, profesyonel ve eyleme geçirilebilir bir özet çıkarmaktır.
                
                Kurallar:
                1.  **Dil:** Sadece Türkçe kullan.
                2.  **Format:** Cevabını MARKDOWN formatında ver.
                3.  **Başlıklar:** 3 adet ana başlık kullan: '### Finansal Performans Özeti', '### Öne Çıkan Gözlemler ve Fırsatlar', '### Aksiyon Önerileri'.
                4.  **Ton:** Profesyonel, kendinden emin ve yapıcı ol.
                5.  **Veri Odaklı Ol:** Mutlaka verilerden spesifik yüzdeler veya TL tutarları ile bahset.
                6.  **Karşılaştırma:** Eğer 'oncekiDonem' verisi varsa, MUTLAKA bu ayla karşılaştır (örn: "Net kâr, Ağustos ayına göre %X arttı/azaldı").
                7.  **Odak Noktaları:** Gelir, gider (özellikle en yüksek gider kalemleri) ve net kâr (nakit akışı) üzerinde dur.
                8.  **Listeleme:** Gözlemleri ve önerileri madde imli (bullet points) liste olarak sun.
            `;
            
            const userQuery = `
                Lütfen şu finansal verileri analiz et:
                ${JSON.stringify(simplifiedData, null, 2)}
            `;

            try {
                // Gemini API Çağrısı
                const apiKey = ""; // API anahtarı Canvas tarafından sağlanır
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API hatası: ${response.statusText}`);
                }

                const result = await response.json();
                const aiText = result.candidates[0].content.parts[0].text;

                // İçeriği 'marked' kütüphanesi ile HTML'e çevir ve göster
                aiContent.innerHTML = marked.parse(aiText);
                aiLoader.classList.add('hidden');

            } catch (error) {
                console.error("Yapay zeka analiz hatası:", error);
                aiLoader.classList.add('hidden');
                aiContent.innerHTML = `<p class="text-rose-400">Yapay zeka analizi sırasında bir hata oluştu. Lütfen konsolu kontrol edin. (Hata: ${error.message})</p>`;
            } finally {
                aiButton.disabled = false;
                aiButton.querySelector('span').textContent = 'Kapsamlı Yapay Zeka Analizi';
                aiButton.querySelector('.spinner')?.remove();
            }
        };

        // --- VERİ GÜNCELLEME FONKSİYONU (YÖNETİCİ) ---
        const handleUpdateData = async () => {
            const docRef = getReportDocRef();
            if (!docRef) return;
            
            const btn = document.getElementById('updateDataBtn');
            btn.disabled = true;
            btn.textContent = 'Güncelleniyor...';

            try {
                await setDoc(docRef, sampleReportData);
                console.log("Veritabanı başarıyla güncellendi.");
                // Veri güncellendiğinde onSnapshot tetiklenecek ve UI otomatik yenilenecek.
            } catch (error) {
                console.error("Veri güncelleme hatası: ", error);
                authMessage.textContent = `Veri güncelleme hatası: ${error.message}`;
                authMessage.className = 'auth-message-error';
            } finally {
                 btn.disabled = false;
                 btn.textContent = 'Örnek Veriyi Güncelle';
            }
        };


        // --- YETKİLENDİRME (AUTH) FONKSİYONLARI ---

        /**
         * E-postanın whitelist'te olup olmadığını kontrol eder.
         * @param {string} email - Kontrol edilecek e-posta
         * @returns {Promise<boolean>} - E-posta listede varsa true
         */
        const isEmailWhitelisted = async (email) => {
            console.log("Whitelist sorgulanıyor: app-access/whitelist");
            try {
                const docRef = doc(db, "app-access", "whitelist");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // E-postaları küçük harfe çevirerek kontrol et
                    const allowedEmails = data.allowedEmails.map(e => e.toLowerCase());
                    return allowedEmails.includes(email.toLowerCase());
                } else {
                    console.error("Whitelist dokümanı bulunamadı!");
                    return false;
                }
            } catch (error) {
                // Bu hata genellikle "Missing or insufficient permissions" hatasıdır.
                // Firebase Kurallarının doğru ayarlandığından emin olun.
                console.error("Whitelist kontrol hatası:", error);
                throw new Error("Erişim hatası (Permissions). Lütfen Firebase > Firestore > Kurallar bölümünü kontrol edin ve yayınladığınızdan emin olun.");
            }
        };


        /**
         * E-posta giriş bağlantısı gönderme işlemini yönetir.
         * @param {Event} e - Form gönderme olayı
         */
        const handleSendSignInLink = async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            
            // auth/argument-error hatasını önlemek için katı e-posta formatı kontrolü
            if (!email || !email.includes('@') || email.length < 5) {
                 setAuthMessage("error", "Lütfen geçerli bir e-posta adresi formatı girin.");
                 return;
            }


            setAuthLoading(true, "Doğrulanıyor...");

            try {
                // 1. Adım: E-postayı whitelist'te kontrol et
                const isAllowed = await isEmailWhitelisted(email);
                
                if (!isAllowed) {
                    throw new Error("Bu e-posta adresi için erişim izni bulunmuyor.");
                }

                // 2. Adım: E-posta bağlantısını gönder
                setAuthLoading(true, "Bağlantı gönderiliyor...");
                
                // --- DÜZELTME: auth/argument-error ve Authorized Domain sorunu için ---
                // Geri dönüş URL'sini, Firebase'in genellikle sorunsuz kabul ettiği ana alan adına sabitliyoruz.
                const actionCodeSettings = {
                    // Yalnızca ana domain kullanılıyor. Firebase ayarlarında da sadece bu domain yetkilendirilmeli.
                    url: 'https://conan20x.github.io/', 
                    handleCodeInApp: false
                };
                // --- DÜZELTME SONU ---

                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                
                // Kullanıcıya bilgi ver ve e-postayı kaydet
                window.localStorage.setItem('emailForSignIn', email);
                setAuthMessage("success", "Giriş bağlantınız e-posta adresinize gönderildi. Lütfen gelen kutunuzu kontrol edin.");

            } catch (error) {
                console.error("Yetki kontrolü veya e-posta gönderme hatası:", error);
                // Hata mesajlarını daha kullanıcı dostu yap
                if (error.code === 'auth/invalid-continue-uri' || error.code === 'auth/argument-error') {
                     // Kodun istediği URL, Firebase'in Eylem URL'si ayarıyla eşleşmediğinde bu hata alınır.
                     setAuthMessage("error", "Güvenlik hatası: Alan adınız (conan20x.github.io) Firebase'de yetkilendirilmemiş. Lütfen 'Authentication > Settings > Authorized domains' bölümüne ve Eylem URL'sine eklediğinizden emin olun.");
                } else {
                    setAuthMessage("error", error.message);
                }
            } finally {
                setAuthLoading(false);
            }
        };

        /**
         * Giriş ekranının yükleme durumunu ayarlar.
         * @param {boolean} isLoading - Yükleniyor mu?
         * @param {string} [message=""] - Buton mesajı
         */
        const setAuthLoading = (isLoading, message = "") => {
            if (isLoading) {
                authButton.disabled = true;
                authButton.innerHTML = `<div class="spinner"></div> <span>${message || "Yükleniyor..."}</span>`;
            } else {
                authButton.disabled = false;
                authButton.innerHTML = '<span>Giriş Bağlantısı Gönder</span>';
            }
        };

        /**
         * Giriş ekranında mesaj gösterir.
         * @param {'success' | 'error'} type - Mesaj türü
         * @param {string} message - Gösterilecek mesaj
         */
        const setAuthMessage = (type, message) => {
            authMessage.textContent = message;
            authMessage.className = type === 'success' ? 'auth-message-success' : 'auth-message-error';
        };

        /**
         * Raporu ve ilgili UI elemanlarını gösterir.
         */
        const showReport = () => {
            authContainer.classList.add('hidden');
            loadingSpinner.classList.remove('hidden'); // Rapor yükleniyor...
            // Rapor verisi onSnapshot'tan geldiğinde loadingSpinner gizlenecek
        };

        /**
         * Giriş ekranını gösterir.
         */
        const showLogin = () => {
            authContainer.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            reportContainer.classList.add('hidden');
            // Aktif dinleyicileri (onSnapshot) durdur
            unsubscribeReport();
            unsubscribeReport = () => {};
        };


        /**
         * Sayfa yüklendiğinde e-posta bağlantısını kontrol eder ve girişi tamamlar.
         */
        const handleSignInRedirect = async () => {
            // Sadece GitHub sayfasındayken bu işlemi yap
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                
                // Önizleme penceresinde window.prompt çalışmayacağı için gerçek sitede test edilmeli.

                if (!email) {
                    console.log("UYARI: E-posta local storage'da bulunamadı. Gerçek sitede (github.io) deniyorsanız, e-posta sorulacaktır.");
                    // Gerçek sitede (github.io) deniyorsa, burada window.prompt ile e-posta sorulur.
                    // Canvas ortamında burayı atlıyoruz.
                    return; 
                }

                setAuthLoading(true, "Giriş doğrulanıyor...");
                
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                    // onAuthStateChanged tetiklenecek ve raporu gösterecek
                } catch (error) {
                    console.error("E-posta ile giriş hatası:", error);
                    setAuthMessage("error", `Giriş hatası: ${error.message}`);
                    setAuthLoading(false);
                }
            }
        };


        // --- UYGULAMANIN BAŞLATILMASI (ANA FONKSİYON) ---
        const initializeMainApp = () => {
            try {
                // Firebase'i manuel yapılandırma ile başlat
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Firebase log seviyesini ayarla (debug için)
                // setLogLevel('debug');

                // 1. Adım: Sayfa URL'sinin bir giriş bağlantısı olup olmadığını kontrol et
                // Bu fonksiyon artık sadece github.io üzerinde çalışacak şekilde güncellendi
                handleSignInRedirect();

                // 2. Adım: Kullanıcının oturum durumunu dinle
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // KULLANICI GİRİŞ YAPTI
                        console.log("Kullanıcı oturum açtı:", user.uid);
                        userId = user.uid;
                        showReport(); // Rapor yükleme ekranını göster
                        
                        // Rapor verisini dinlemeye başla
                        const docRef = getReportDocRef();
                        if (docRef) {
                            unsubscribeReport = onSnapshot(docRef, (doc) => {
                                loadingSpinner.classList.add('hidden'); // Veri geldi, yüklemeyi gizle
                                reportContainer.classList.remove('hidden'); // Raporu göster
                                
                                if (doc.exists()) {
                                    console.log("Rapor verisi yüklendi.");
                                    const reportData = doc.data();
                                    const activeMonth = reportData.activeMonth || Object.keys(reportData.reports)[0];
                                    
                                    // Dashboard'u bu veriyle güncelle
                                    updateDashboard(reportData, activeMonth);
                                    
                                    // Dinleyicileri (sadece bir kez) ayarla
                                    if (!window.listenersAttached) {
                                        setupChartToggleListeners();
                                        setupMonthSwitcherListener(reportData);
                                        
                                        // AI Analiz butonu
                                        document.getElementById('runAiAnalysisBtn').onclick = () => {
                                            const currentMonthKey = document.querySelector('.month-button[data-active="true"]').dataset.monthKey;
                                            handleAiAnalysis(reportData, currentMonthKey);
                                        };
                                        
                                        // Veri Güncelleme butonu (Admin)
                                        document.getElementById('updateDataBtn').onclick = handleUpdateData;
                                        
                                        window.listenersAttached = true;
                                    }
                                } else {
                                    console.error("Rapor veri dokümanı bulunamadı!");
                                    authContainer.classList.remove('hidden');
                                    loadingSpinner.classList.add('hidden');
                                    setAuthMessage("error", "Rapor verisi bulunamadı. Lütfen yönetici ile iletişime geçin.");
                                }
                            }, (error) => {
                                console.error("Rapor dinleme hatası: ", error);
                                loadingSpinner.classList.add('hidden');
                                setAuthMessage("error", `Rapor verisi okunurken hata: ${error.message}`);
                            });
                        }
                    } else {
                        // KULLANICI GİRİŞ YAPMADI (veya çıkış yaptı)
                        console.log("Kullanıcı oturumu kapalı.");
                        showLogin(); // Giriş ekranını göster
                    }
                });

                // 3. Adım: Giriş formu dinleyicisini ayarla
                authForm.addEventListener('submit', handleSendSignInLink);

            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                document.body.innerHTML = `<div style="color: red; padding: 2rem;">Firebase başlatılamadı. Lütfen konsolu kontrol edin. Hata: ${error.message}</div>`;
            }
        };

        // Uygulamayı Başlat
        document.addEventListener('DOMContentLoaded', initializeMainApp);

    </script>

</body>

</html>
