<!DOCTYPE html>
<html lang="tr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Drink & Dessert Cadde Şube Ağustos 2025 Raporu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            /* A deep blue-gray for dark mode */
            color: #E2E8F0;
            /* A light gray for text */
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }

        .kpi-card {
            background-color: #1E293B;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }

        .card {
            background-color: #1E293B;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #334155;
        }

        .total-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 1.25rem;
            color: #E2E8F0;
            text-align: center;
        }

        .chart-control-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            background-color: #312E81;
            color: #A5B4FC;
        }

        .chart-control-btn.active {
            background-color: #6366F1;
            color: #1E1B4B;
        }
    </style>
</head>

<body class="antialiased">
    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
        <div class="absolute text-xl font-semibold text-gray-200">Rapor Yükleniyor...</div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 hidden" id="report-container">
        <header class="relative text-center mb-10 flex flex-col items-center">
            <img src="https://placehold.co/200x50/0F172A/FFFFFF?text=BOSTON" alt="Boston Drink & Dessert Logo Dark" class="mb-4">
            <h1 class="text-4xl font-bold text-white">Boston Drink & Dessert Cadde Şube Ağustos 2025 Raporu</h1>
            <p class="text-lg text-[#67E8F9] mt-2" id="report-period">Dönem: Yükleniyor...</p>
        </header>

        <section id="overview" class="mb-12">
            <h2 class="text-2xl font-bold text-center mb-6">Genel Bakış</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="kpi-card text-center flex flex-col items-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-8 h-8 text-green-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>
                        <h3 class="text-lg font-semibold text-[#67E8F9]">Brüt Gelir</h3>
                    </div>
                    <p class="text-4xl font-bold text-[#06D6A0] mt-2" id="brut-gelir">Yükleniyor...</p>
                </div>
                <div class="kpi-card text-center flex flex-col items-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-8 h-8 text-red-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6 9 12.75l4.286-4.286a11.948 11.948 0 0 1 4.306 6.43l.776 2.898m0 0-3.182-5.511m3.182 5.51-5.511-3.181" /></svg>
                        <h3 class="text-lg font-semibold text-[#67E8F9]">Toplam Gider</h3>
                    </div>
                    <p class="text-4xl font-bold text-[#FF6B6B] mt-2" id="toplam-gider">Yükleniyor...</p>
                </div>
                <div class="kpi-card text-center flex flex-col items-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-8 h-8 text-yellow-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" ><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" /></svg>
                        <h3 class="text-lg font-semibold text-[#67E8F9]">Net Dönem Kârı</h3>
                    </div>
                    <p class="text-4xl font-bold text-[#FFD166] mt-2" id="net-kar">Yükleniyor...</p>
                </div>
            </div>
        </section>

        <!-- Chart Sections -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
             <section id="gross-income" class="card">
                <h2 class="text-2xl font-bold text-center mb-2">Brüt Gelirlerin Dağılımı</h2>
                <p class="text-center text-gray-400 mb-4" id="gross-income-subtitle">Yükleniyor...</p>
                <div class="flex justify-center gap-2 mb-4 chart-controls" data-chart-id="grossIncomeChart">
                    <button class="chart-control-btn active" data-type="doughnut">Doughnut</button>
                    <button class="chart-control-btn" data-type="pie">Pie</button>
                    <button class="chart-control-btn" data-type="bar">Bar</button>
                </div>
                <div class="chart-container mb-6">
                    <canvas id="grossIncomeChart"></canvas>
                    <div class="total-label" id="grossIncomeTotal"></div>
                </div>
                <div id="gross-income-list" class="space-y-3"></div>
            </section>

            <section id="net-income" class="card">
                <h2 class="text-2xl font-bold text-center mb-2">Net Gelirlerin Dağılımı</h2>
                <p class="text-center text-gray-400 mb-4" id="net-income-subtitle">Yükleniyor...</p>
                 <div class="flex justify-center gap-2 mb-4 chart-controls" data-chart-id="netIncomeChart">
                    <button class="chart-control-btn active" data-type="doughnut">Doughnut</button>
                    <button class="chart-control-btn" data-type="pie">Pie</button>
                    <button class="chart-control-btn" data-type="bar">Bar</button>
                </div>
                <div class="chart-container mb-6">
                    <canvas id="netIncomeChart"></canvas>
                    <div class="total-label" id="netIncomeTotal"></div>
                </div>
                <div id="net-income-list" class="space-y-3"></div>
            </section>
        </div>

        <section id="chocolate-analysis" class="card mb-12">
            <h2 class="text-2xl font-bold text-center mb-2">Çikolata Kullanım ve Gider Analizi</h2>
            <p class="text-center text-gray-400 mb-6">Kullanılan çikolataların miktar (KG) ve toplam maliyet (?) dökümü.</p>
             <div class="flex justify-center gap-2 mb-4 chart-controls" data-chart-id="chocolateChart">
                    <button class="chart-control-btn active" data-type="doughnut">Doughnut</button>
                    <button class="chart-control-btn" data-type="pie">Pie</button>
                    <button class="chart-control-btn" data-type="bar">Bar</button>
                </div>
            <div class="chart-container mb-6">
                <canvas id="chocolateChart"></canvas>
                <div class="total-label" id="chocolateTotal"></div>
            </div>
            <div id="chocolate-list" class="space-y-3"></div>
        </section>

        <section id="expenses" class="card mb-12">
            <h2 class="text-2xl font-bold text-center mb-2">Giderlerin Dağılımı</h2>
            <p class="text-center text-gray-400 mb-6">Tüm banka ve kasadan yapılan giderlerin detaylı dökümü.</p>
             <div class="flex justify-center gap-2 mb-4 chart-controls" data-chart-id="expenseChart">
                <button class="chart-control-btn active" data-type="doughnut">Doughnut</button>
                <button class="chart-control-btn" data-type="pie">Pie</button>
                <button class="chart-control-btn" data-type="bar">Bar</button>
            </div>
            <div class="chart-container mb-6">
                <canvas id="expenseChart"></canvas>
                <div class="total-label" id="expenseTotal"></div>
            </div>
            <div id="expense-list" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </section>

        <section id="food-cards" class="card mb-12">
            <h2 class="text-2xl font-bold text-center mb-2">Personel Yemek Kartları Analizi</h2>
            <p class="text-center text-gray-400 mb-6">Personele ait yemek kartlarına yüklenen toplam tutarlar.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                     <div class="flex justify-center gap-2 mb-4 chart-controls" data-chart-id="foodCardChart">
                        <button class="chart-control-btn active" data-type="doughnut">Doughnut</button>
                        <button class="chart-control-btn" data-type="pie">Pie</button>
                        <button class="chart-control-btn" data-type="bar">Bar</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="foodCardChart"></canvas>
                        <div class="total-label" id="foodCardTotal"></div>
                    </div>
                </div>
                <div id="food-card-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 border-l-2 pl-4 border-gray-700">
                </div>
            </div>
        </section>
        
        <section id="shipment" class="card mb-12">
            <h2 class="text-2xl font-bold text-center mb-2">Genel Merkez Sevkiyat Detayları</h2>
            <p class="text-center text-gray-400 mb-6">Dönem içinde genel merkezden yapılan ürün sevkiyatlarının dökümü.</p>
            <div id="shipment-list" class="space-y-3">
            </div>
            <div id="shipment-total-container" class="mt-6 pt-4 border-t-2 border-dashed border-gray-700 text-right">
                <span class="text-lg font-semibold text-gray-400">Sevkiyat Toplam Tutarı:</span>
                <span id="shipment-total" class="text-2xl font-bold text-white ml-2">Yükleniyor...</span>
            </div>
        </section>


        <section id="cashflow" class="card mb-12">
            <h2 class="text-2xl font-bold text-center mb-2">Nakit Akışı ve Banka Analizi</h2>
            <p class="text-center text-gray-400 mb-6">Bankaya yatan net tutarlar ile tüm giderler arasındaki fark.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="font-bold text-lg mb-4 text-center">Online Platform Komisyon Analizi</h3>
                    <div id="online-commission-list" class="space-y-4"></div>
                    <div class="mt-6 p-4 bg-blue-900 bg-opacity-30 border-l-4 border-blue-500 rounded-r-lg">
                        <h4 class="font-bold text-blue-300" id="total-commission-header"></h4>
                        <p class="text-blue-400" id="total-commission-text"></p>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4 text-center">Dönem Sonu Finansal Durum</h3>
                    <div id="financial-status-list" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <section id="admin-panel" class="card mt-12 mb-12">
            <h2 class="text-2xl font-bold text-center mb-4">Veri Yönetimi (Gizli)</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <p>Bu bölüm yalnızca yetkili kullanıcılar içindir.</p>
                <button id="updateDataBtn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition duration-300 shadow-lg">Örnek Veriyi Güncelle</button>
            </div>
        </section>

        <footer class="text-center text-sm text-gray-400 mt-12">
            <p>Bu rapor, güvenli veri kaynaklarına dayanarak oluşturulmuştur ve finansal danışmanlık yerine geçmez.</p>
            <p>Rapor Tarihi: 6 Eylül 2025</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ve Uygulama Ayarları 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;
        let charts = {};
        let reportDataCache = null;

        const loadingSpinner = document.getElementById('loading-spinner');
        const reportContainer = document.getElementById('report-container');
        
        // --- NEW: Chart State Management ---
        const chartStates = {
            grossIncomeChart: 'doughnut',
            netIncomeChart: 'doughnut',
            chocolateChart: 'doughnut',
            expenseChart: 'doughnut',
            foodCardChart: 'doughnut'
        };

        // --- UPDATED: SVG and Brand Icons ---
        const icons = {
            'Kredi Kartı': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3 text-blue-500"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>`,
            'Nakit': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3 text-green-500"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            'Yemeksepeti Online': `<svg class="w-6 h-6 mr-2" viewBox="0 0 512 512"><path fill="#ED5058" d="M351.9,4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbRyFTLRNyDmT1a1boZV"/></svg>`,
            'Getir Online': `<svg class="w-6 h-6 mr-2" viewBox="0 0 24 24"><path fill="#5D3EBC" d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Z"/><path fill="#FFD440" d="M12.6,13.4l-1.8-3-1.8,3H6.5l3.6-5.5h3.3l1.3,2,2-3.2,2,3.2,1.3-2h2L17,17l-4.4-3.6Z"/></svg>`,
            'Trendyol Online': `<svg class="w-6 h-6 mr-2" viewBox="0 0 100 100"><path fill="#f27a13" d="M88.7 72.1L69.3 61.4c-2-1.2-4.6-.1-6 1.7l-9.2 10.8c-.2 0-.5-.1-.7-.2l-17-9.9c-5.9-3.4-10.1-9.8-10.1-16.4l3.8-4.4c-2.1-1.8-3.9-4.3-4.3-6.5L35.1 22c-.3-1.9-1.7-3.4-3.4-3.4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbRyFTLRNyDmT1a1boZV.4-6-1.1-7.9z"/></svg>`
        };
        
        const chocolateColorMap = {
            'Sütlü Çikolata': { bg: 'bg-amber-900/30', text: 'text-amber-400' },
            'Bitter Çikolata': { bg: 'bg-gray-700/30', text: 'text-gray-300' },
            'Beyaz Çikolata': { bg: 'bg-yellow-900/20', text: 'text-yellow-400' },
            'Ruby Çikolata': { bg: 'bg-pink-900/30', text: 'text-pink-400' },
            'Gold Çikolata': { bg: 'bg-yellow-800/30', text: 'text-yellow-300' },
        };

        const sampleReportData = {
            period: '01.08.2025 - 04.09.2025',
            kpi: { brutGelir: 1704018.00, toplamGider: 1347540.82, netKar: 109550.17 },
            grossIncome: { labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit'], data: [728958, 547510, 162820, 142555, 122175] },
            netIncome: { labels: ['Kredi Kartı', 'Yemeksepeti Online', 'Getir Online', 'Trendyol Online', 'Nakit'], data: [729092.33, 396173.05, 104019.71, 96789.04, 122175] },
            chocolate: {
                labels: ['Sütlü Çikolata', 'Bitter Çikolata', 'Beyaz Çikolata', 'Ruby Çikolata', 'Gold Çikolata'],
                costs: [
                    { name: 'Sütlü Çikolata', kg: 360, pricePerKg: 690 }, { name: 'Bitter Çikolata', kg: 40, pricePerKg: 730 }, { name: 'Beyaz Çikolata', kg: 60, pricePerKg: 690 },
                    { name: 'Ruby Çikolata', kg: 12.5, pricePerKg: 835 }, { name: 'Gold Çikolata', kg: 15, pricePerKg: 950 }
                ],
                colors: ['#A0522D', '#3B2F2F', '#F5F5DC', '#E91E63', '#FFD700']
            },
            expenses: {
                labels: [ 'Genel Merkeze Ödeme', 'Personel Maaşları (Banka)', 'Personel Maaşları (Nakit)', 'Stajyer Maaşı', 'Kredi Kartı Borç Ödemesi', 'Dükkan Kirası', 'Ev Kirası', 'Manav Ödemesi', 'Elektrik Faturası', 'Geçici Vergi Ödemesi', 'Yemek Kartları Ödemesi', 'İçim Süt Ödemesi', 'Nakit Diğer Ödemeler', 'Arıtma Değişim Ücreti', 'Su Faturası', 'Cam Temizlik Ödeme', 'Vantilatör Lamba Ödemesi', 'Filtre Bakım Ödemesi', 'İlaçlama Ödeme', 'Yazılım Bakım Ücreti', 'Telefon Faturası', 'İnternet Faturası', 'Havale Ücreti' ],
                data: [ 4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbRyFTLRNyDmT1a1boZV20001.54, 24697.62, 12730.00, 8400.00, 5126.00, 4800.00, 2000.00, 1500.00, 1500.00, 798.00, 781.50, 420.00, 409.42 ]
            },
            foodCards: {
                labels: ['Merve', 'Nesibe', 'Hacer', 'Enise', 'Ezel', 'Berkay', 'Emre Albay', 'Furkan', 'İbrahim', 'Emre Yeşilçayır', 'Taha', 'Aslı', 'Alp', 'Yeşim'],
                data: [3030, 2042.54, 3030, 3000, 1900, 1590, 2176, 2170, 441, 1465, 1235, 370, 1820, 1792]
            },
            shipmentDetails: [
                 { name: 'CALLEBAUT BEYAZ ÇİKOLATA (10 KG)', quantity: 60, unit: 'KG', price: 4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbRyFTLRNyDmT1a1boZV },
                 { name: 'CALLEBAUT RUBY ÇİKOLATA (10 KG)', quantity: 10, unit: 'KG', price: 8433.50 }, { name: 'CALLEBAUT SÜTLÜ ÇİKOLATA (10 KG)', quantity: 300, unit: 'KG', price: 209070.00 },
                 { name: 'BOSTON CRUST PAKET ALL IN ONE KUTU 1/1', quantity: 1, unit: 'PAKET', price: 3600.00 }, { name: 'BOSTON CRUST PAKET ALL IN ONE KUTU 1/2', quantity: 1, unit: 'PAKET', price: 2760.00 },
                 { name: 'BOSTON BASKILI KRAFT SAPLI ÇANTA', quantity: 1, unit: 'KOLİ', price: 1500.00 }, { name: 'BASKILI KRAFT KESE KAĞIDI KG', quantity: 1, unit: 'KOLİ', price: 3240.00 },
                 { name: 'BOSTON BASKILI PEÇETE', quantity: 2, unit: 'ADET', price: 2040.00 }, { name: 'BOSTON CRUST MIX WAFFLE KUTU', quantity: 1, unit: 'PAKET', price: 2100.00 },
                 { name: 'BOSTON BASKILI MİNİ KAP', quantity: 2, unit: 'KOLİ', price: 4320.00 }, { name: 'BOSTON BASKILI TAM KAP', quantity: 1, unit: 'KOLİ', price: 1710.00 },
                 { name: 'BOSTON BASKILI ŞEFFAF BARDAK 12 OZ', quantity: 1, unit: 'KOLİ', price: 3840.00 }, { name: 'TORKU TAM BUĞDAYLI BİSKÜVİ TOZU', quantity: 2, unit: 'KOLİ', price: 1575.60 },
                 { name: 'CALLEBAUT KREP KIRIĞI (10 KG)', quantity: 20, unit: 'KG', price: 13332.00 }, { name: 'BOSTON BASKILI DEMLİK POŞET ÇAY', quantity: 1, unit: 'KOLİ', price: 1818.00 },
                 { name: 'DVG BAR SOS KARAMEL (2KG)', quantity: 1, unit: 'ADET', price: 1187.76 }, { name: 'CALLEBAUT GOLD KARAMEL ÇİKOLATA (10KG)', quantity: 10, unit: 'KG', price: 9595.00 }
            ],
            onlineCommissions: [
                 { name: 'Yemeksepeti', gross: 547510.00, net: 396173.05, color: '#FF6B6B' }, { name: 'Getir', gross: 162820.00, net: 104019.71, color: '#FFD166' },
                 { name: 'Trendyol', gross: 142555.00, net: 96789.04, color: '#06D6A0' }
            ],
            financialStatus: { bankaGelirleri: 1334915.99, bankaGiderleri: 1258695.82, nakitGelir: 122175.00, nakitGider: 88845.00 }
        };

        const formatCurrency = (value) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(value);
        const formatAmountWithSign = (amount) => {
            const formatted = formatCurrency(Math.abs(amount));
            return amount < 0 ? `-` + formatted : formatted;
        };

        const createOrUpdateChart = (ctxId, type, labels, data, colors, totalElementId) => {
            const ctx = document.getElementById(ctxId).getContext('2d');
            const totalLabel = document.getElementById(totalElementId);
            
            if (charts[ctxId]) {
                charts[ctxId].destroy();
            }

            const isCircular = ['doughnut', 'pie', 'polarArea'].includes(type);
            if (totalLabel) {
                 const total = data.reduce((sum, val) => sum + val, 0);
                 totalLabel.textContent = formatCurrency(total);
                 totalLabel.style.display = isCircular ? 'block' : 'none';
            }
            
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 }, color: '#E2E8F0' }
                    },
                    tooltip: { callbacks: { label: (context) => `${context.label}: ${formatCurrency(context.raw)}` } }
                }
            };
            
            if (type === 'doughnut') options.cutout = '60%';
            if (type === 'bar') {
                options.plugins.legend.display = false; // Fix for 'undefined' legend
                options.scales = {
                    y: { beginAtZero: true, ticks: { color: '#94A3B8' } },
                    x: { ticks: { color: '#94A3B8' } }
                };
            }

            charts[ctxId] = new Chart(ctx, {
                type,
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderColor: '#1E293B',
                        borderWidth: type === 'bar' ? 0 : 3
                    }]
                },
                options
            });
        };
        
        const createListWithIcons = (listId, data, colorClass, formatFunc, iconMap) => {
            const listContainer = document.getElementById(listId);
            listContainer.innerHTML = '';
            data.forEach(item => {
                const div = document.createElement('div');
                const iconHTML = iconMap[item.label] || '';
                div.className = `flex justify-between items-center p-3 rounded-lg ${colorClass}`;
                div.innerHTML = `<div class="flex items-center"><span class="font-medium">${iconHTML}${item.label}</span></div><span class="font-bold">${formatFunc(item.value)}</span>`;
                listContainer.appendChild(div);
            });
        };
        
        const renderReport = (data) => {
            if (!data) return;
            reportDataCache = data; // Cache the data

            document.getElementById('report-period').textContent = `Dönem: ${data.period}`;
            document.getElementById('brut-gelir').textContent = formatCurrency(data.kpi.brutGelir);
            document.getElementById('toplam-gider').textContent = formatCurrency(data.kpi.toplamGider);
            document.getElementById('net-kar').textContent = formatCurrency(data.kpi.netKar);
            
            // --- Sections using the new chart function ---
            const grossIncomeTotal = data.grossIncome.data.reduce((s, v) => s + v, 0);
            document.getElementById('gross-income-subtitle').textContent = `Kasa raporuna göre toplam ${formatCurrency(grossIncomeTotal)}'lik brüt gelirin kaynaklara göre dökümü.`;
            createListWithIcons('gross-income-list', data.grossIncome.labels.map((l, i) => ({ label: l, value: data.grossIncome.data[i] })).sort((a,b) => b.value - a.value), 'bg-green-900/20', formatCurrency, icons);
            createOrUpdateChart('grossIncomeChart', chartStates.grossIncomeChart, data.grossIncome.labels, data.grossIncome.data, ['#118AB2', '#06D6A0', '#FFD166', '#EF4444', '#073B4C'], 'grossIncomeTotal');

            document.getElementById('net-income-subtitle').textContent = `Bankaya yatan ve kasadaki net gelirin kaynaklara göre dökümü.`;
            createListWithIcons('net-income-list', data.netIncome.labels.map((l, i) => ({ label: l, value: data.netIncome.data[i] })).sort((a,b) => b.value - a.value), 'bg-green-900/20', formatCurrency, icons);
            createOrUpdateChart('netIncomeChart', chartStates.netIncomeChart, data.netIncome.labels, data.netIncome.data, ['#118AB2', '#06D6A0', '#FFD166', '#EF4444', '#073B4C'], 'netIncomeTotal');

            const chocolateDetails = data.chocolate.costs.map((c, i) => ({...c, totalCost: c.kg * c.pricePerKg, color: data.chocolate.colors[i] })).sort((a, b) => b.totalCost - a.totalCost);
            createOrUpdateChart('chocolateChart', chartStates.chocolateChart, chocolateDetails.map(c => c.name), chocolateDetails.map(c => c.totalCost), chocolateDetails.map(c => c.color), 'chocolateTotal');
            
            const chocolateList = document.getElementById('chocolate-list');
            chocolateList.innerHTML = '';
            chocolateDetails.forEach(c => {
                 const div = document.createElement('div');
                 const colorClasses = chocolateColorMap[c.name] || { bg: 'bg-slate-800', text: '' };
                 div.className = `flex justify-between items-center p-3 rounded-lg ${colorClasses.bg}`;
                 div.innerHTML = `<span class="font-medium">${c.name}</span><span class="font-bold ${colorClasses.text}">${c.kg} KG (${formatCurrency(c.totalCost)})</span>`;
                 chocolateList.appendChild(div);
            });
            
            const categorizedExpenses = {
                'Genel Merkeze Ödeme': data.expenses.data[0], 'Personel Maaşları': data.expenses.data[1] + data.expenses.data[2] + data.expenses.data[3],
                'Kredi Kartı Borcu': data.expenses.data[4], 'Kiralar': data.expenses.data[5] + data.expenses.data[6], 'Manav Ödemesi': data.expenses.data[7],
                'Vergi & Faturalar': data.expenses.data[8] + data.expenses.data[9] + data.expenses.data[14] + data.expenses.data[20] + data.expenses.data[21],
                'Diğer Giderler': [10, 11, 12, 13, 15, 16, 17, 18, 19, 22].reduce((s, i) => s + data.expenses.data[i], 0)
            };
            const sortedCategorizedExpenses = Object.entries(categorizedExpenses).sort(([, a], [, b]) => b - a);
            createOrUpdateChart('expenseChart', chartStates.expenseChart, sortedCategorizedExpenses.map(([l]) => l), sortedCategorizedExpenses.map(([,v]) => v), ['#FF6B6B', '#073B4C', '#118AB2', '#F79256', '#7DCFB6', '#FBD1A2', '#BDB2FF'], 'expenseTotal');

            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            data.expenses.labels.map((l, i) => ({ label: l, value: data.expenses.data[i] })).sort((a,b) => b.value - a.value).forEach(e => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-red-900/20 rounded-lg';
                div.innerHTML = `<span>${e.label}</span><span class="font-bold text-red-400">${formatAmountWithSign(-e.value)}</span>`;
                expenseList.appendChild(div);
            });
            
            const foodCards = data.foodCards.labels.map((l, i) => ({ label: l, value: data.foodCards.data[i] })).sort((a,b) => b.value - a.value);
            createOrUpdateChart('foodCardChart', chartStates.foodCardChart, foodCards.map(fc => fc.label), foodCards.map(fc => fc.value), ['#8E44AD', '#3498DB', '#1ABC9C', '#F1C40F', '#E67E22', '#E74C3C', '#95A5A6', '#34495E', '#2ECC71', '#D35400', '#C0392B', '#7F8C8D', '#16A085', '#2980B9'], 'foodCardTotal');
            
            const foodCardList = document.getElementById('food-card-list');
            foodCardList.innerHTML = '';
            foodCards.forEach(fc => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 rounded-lg bg-indigo-900/20';
                div.innerHTML = `<span class="font-medium">${fc.label}</span><span class="font-bold">${formatCurrency(fc.value)}</span>`;
                foodCardList.appendChild(div);
            });

            const shipmentList = document.getElementById('shipment-list');
            shipmentList.innerHTML = '';
            let totalShipmentCost = 0;
            [...data.shipmentDetails].sort((a,b) => b.price - a.price).forEach(item => {
                totalShipmentCost += item.price;
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 bg-slate-700 rounded-lg';
                div.innerHTML = `<div class="font-medium text-gray-200">${item.name} <span class="text-sm text-gray-4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbRyFTLRNyDmT1a1boZVmt-0">${formatCurrency(item.price)}</div>`;
                shipmentList.appendChild(div);
            });
            document.getElementById('shipment-total').textContent = formatCurrency(totalShipmentCost);

            const onlineCommissionList = document.getElementById('online-commission-list');
            onlineCommissionList.innerHTML = '';
            let totalCommission = 0;
            data.onlineCommissions.forEach(p => {
                const commission = p.gross - p.net; totalCommission += commission;
                const pct = ((commission / p.gross) * 100).toFixed(1);
                const div = document.createElement('div');
                div.innerHTML = `<div><div class="flex justify-between font-semibold"><span>${p.name}</span><span class="text-red-4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbRyFTLRNyDmT1a1boZVfull h-4 mt-1"><div class="bg-[#FF6B6B] h-4 rounded-full" style="width: ${pct}%"></div></div><div class="flex justify-between text-sm text-gray-4JUdGzvrMFDWrUUwY3toJATSeNwjn54LkCnKBPRzDuhzi5vSepHfUckJNxRL2gjkNrSqtCoRUrEDAgRwsQvVCjZbRyFTLRNyDmT1a1boZV>`;
                onlineCommissionList.appendChild(div);
            });

            document.getElementById('total-commission-header').textContent = `Toplam Komisyon Gideri: ${formatCurrency(totalCommission)}`;
            document.getElementById('total-commission-text').textContent = `Online platformlardan elde edilen ${formatCurrency(data.onlineCommissions.reduce((s, p) => s + p.gross, 0))} brüt cironun bankaya yatan net karşılığı ${formatCurrency(data.onlineCommissions.reduce((s, p) => s + p.net, 0))}'dir.`;

            const financialStatusList = document.getElementById('financial-status-list');
            const bankNetFlow = data.financialStatus.bankaGelirleri - data.financialStatus.bankaGiderleri;
            const cashNetFlow = data.financialStatus.nakitGelir - data.financialStatus.nakitGider;
            financialStatusList.innerHTML = `
                <div class="flex justify-between p-3 rounded-lg bg-slate-700"><span>Banka Gelirleri</span><span class="font-medium text-green-400">${formatCurrency(data.financialStatus.bankaGelirleri)}</span></div>
                <div class="flex justify-between p-3 rounded-lg bg-slate-700"><span>Banka Giderleri</span><span class="font-medium text-red-400">${formatAmountWithSign(-data.financialStatus.bankaGiderleri)}</span></div>
                <div class="flex justify-between p-3 rounded-lg bg-blue-900/30 font-bold"><span>Banka Net Akışı</span><span>${formatAmountWithSign(bankNetFlow)} ?</span></div>
                <hr class="my-3 border-gray-700">
                <div class="flex justify-between p-3 rounded-lg bg-slate-700"><span>Nakit Gelir</span><span class="font-medium text-green-400">${formatCurrency(data.financialStatus.nakitGelir)}</span></div>
                <div class="flex justify-between p-3 rounded-lg bg-slate-700"><span>Nakit Gider</span><span class="font-medium text-red-400">${formatAmountWithSign(-data.financialStatus.nakitGider)}</span></div>
                <div class="flex justify-between p-3 rounded-lg bg-blue-900/30 font-bold"><span>Kasa Net Akışı</span><span>${formatAmountWithSign(cashNetFlow)} ?</span></div>
                <hr class="my-3 border-2 border-dashed border-gray-700">
                <div class="flex justify-between p-4 rounded-lg bg-yellow-900/30 text-yellow-300 font-bold text-lg"><span>Toplam Varlık</span><span>${formatAmountWithSign(bankNetFlow + cashNetFlow)} ?</span></div>
            `;

            loadingSpinner.classList.add('hidden');
            reportContainer.classList.remove('hidden');
        };
        
        // --- UPDATED: Global Chart Control Logic ---
        document.body.addEventListener('click', (e) => {
            if (e.target.matches('.chart-controls .chart-control-btn')) {
                const newChartType = e.target.dataset.type;

                // Update all chart states
                for (const chartId in chartStates) {
                    chartStates[chartId] = newChartType;
                }

                // Update the 'active' class on ALL chart control groups
                document.querySelectorAll('.chart-controls').forEach(container => {
                    container.querySelectorAll('button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.type === newChartType);
                    });
                });

                if (reportDataCache) {
                    renderReport(reportDataCache);
                }
            }
        });

        // Veritabanı ve kimlik doğrulama işlemleri 
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            const docRef = doc(db, `artifacts/${appId}/public/data/reports`, 'agustos2025-rapor');
                            onSnapshot(docRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    renderReport(docSnap.data());
                                } else {
                                    setDoc(docRef, sampleReportData);
                                }
                            });
                        }
                    });
                } else {
                    renderReport(sampleReportData); // Fallback for local testing
                }
            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                renderReport(sampleReportData); // Fallback on error
            }

            document.getElementById('updateDataBtn').addEventListener('click', () => {
                if(db && userId) {
                     const docRef = doc(db, `artifacts/${appId}/public/data/reports`, 'agustos2025-rapor');
                     setDoc(docRef, sampleReportData)
                        .then(() => alert("Örnek veri başarıyla güncellendi."))
                        .catch(e => console.error("Veri güncellenirken hata oluştu: ", e));
                } else {
                    alert("Veritabanı bağlantısı yok. Güncelleme yapılamıyor.");
                }
            });
        });
    </script>
</body>
</html>

